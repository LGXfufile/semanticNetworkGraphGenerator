<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­ä¹‰ç½‘ç»œå›¾ç”Ÿæˆå™¨</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .upload-section {
      margin-bottom: 30px;
      padding: 25px;
      border: 2px dashed #007bff;
      border-radius: 8px;
      text-align: center;
      background: #f8f9ff;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background-color: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
    }
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    .btn-success:hover {
      background-color: #218838;
      transform: translateY(-2px);
    }
    .btn-info {
      background-color: #17a2b8;
      color: white;
    }
    .btn-info:hover {
      background-color: #138496;
      transform: translateY(-2px);
    }
    #file {
      margin: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    #main {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
      background: white;
    }
    .status {
      margin: 15px 0;
      padding: 15px;
      border-radius: 6px;
      font-weight: 500;
    }
    .status.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸŒ è¯­ä¹‰ç½‘ç»œå›¾ç”Ÿæˆå™¨</h1>
    <p>ä¸Šä¼ Excelæ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯äº¤äº’çš„è¯­ä¹‰ç½‘ç»œå›¾ï¼Œæ”¯æŒä¸‹è½½å›¾ç‰‡åˆ°æœ¬åœ°</p>
    
    <div class="upload-section">
      <h3>ğŸ“ æ–‡ä»¶ä¸Šä¼ </h3>
      <p>è¯·å…ˆä¸‹è½½æ•°æ®æ¨¡ç‰ˆï¼ŒæŒ‰ç…§æ ¼å¼å¡«å†™æ•°æ®åä¸Šä¼ </p>
      
      <div class="button-group">
        <button class="btn btn-info" onclick="downloadTemplate()">
          ğŸ“¥ ä¸‹è½½æ•°æ®æ¨¡ç‰ˆ
        </button>
        <input type="file" id="file" accept=".xlsx,.xls" />
        <button class="btn btn-success" id="download" style="display: none;">
          ğŸ–¼ï¸ ä¸‹è½½å›¾ç‰‡
        </button>
      </div>
    </div>
    
    <div id="status"></div>
    <div id="main"></div>
  </div>

  <!-- å°†åŸæ¥çš„CDNé“¾æ¥æ›¿æ¢ä¸ºå›½å†…CDN -->
  <script src="https://cdn.bootcdn.net/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
  
  <script>
    let chart = null;
    
    // æ¨¡ç‰ˆæ•°æ®
    const templateData = [
      ['èŠ‚ç‚¹A', 'èŠ‚ç‚¹B', 'å…³ç³»ç±»å‹', 'èŠ‚ç‚¹Aç±»å‹', 'èŠ‚ç‚¹Bç±»å‹'],
      ['è¥¿æ¹–', 'ç¾ä¸½', 'æ­£é¢è¯„ä»·', 'æ—…æ¸¸åœ°', 'æ­£é¢è¯„è®ºè¯'],
      ['è¥¿æ¹–', 'è´µ', 'è´Ÿé¢è¯„ä»·', 'æ—…æ¸¸åœ°', 'è´Ÿé¢è¯„è®ºè¯'],
      ['è¥¿æ¹–', 'è‡ªç„¶æ™¯è§‚', 'åŒ…å«è¦ç´ ', 'æ—…æ¸¸åœ°', 'æ—…æ¸¸è¦ç´ '],
      ['è‡ªç„¶æ™¯è§‚', 'å£®è§‚', 'æ­£é¢å…³è”', 'æ—…æ¸¸è¦ç´ ', 'æ­£é¢è¯„è®ºè¯'],
      ['ç¾ä¸½', 'å£®è§‚', 'æƒ…æ„Ÿå…³è”', 'æ­£é¢è¯„è®ºè¯', 'æ­£é¢è¯„è®ºè¯']
    ];
    
    // ä¸‹è½½æ•°æ®æ¨¡ç‰ˆ
    function downloadTemplate() {
      try {
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'æ•°æ®æ¨¡ç‰ˆ');
        
        // è®¾ç½®åˆ—å®½
        const colWidths = [
          { wch: 15 }, // èŠ‚ç‚¹A
          { wch: 15 }, // èŠ‚ç‚¹B
          { wch: 12 }, // å…³ç³»ç±»å‹
          { wch: 15 }, // èŠ‚ç‚¹Aç±»å‹
          { wch: 15 }  // èŠ‚ç‚¹Bç±»å‹
        ];
        ws['!cols'] = colWidths;
        
        XLSX.writeFile(wb, 'è¯­ä¹‰ç½‘ç»œå›¾æ•°æ®æ¨¡ç‰ˆ.xlsx');
        showStatus('æ•°æ®æ¨¡ç‰ˆä¸‹è½½æˆåŠŸï¼è¯·æŒ‰ç…§æ¨¡ç‰ˆæ ¼å¼å¡«å†™æ•°æ®', 'success');
      } catch (error) {
        showStatus('æ¨¡ç‰ˆä¸‹è½½å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      if (type === 'error') {
        console.error(message);
      }
    }
    
    // æ ¹æ®èŠ‚ç‚¹ç±»å‹è·å–é¢œè‰²
    function getNodeColor(nodeType) {
      const colorMap = {
        'æ—…æ¸¸åœ°': '#000000',
        'æ­£é¢è¯„è®ºè¯': '#87CEEB',
        'è´Ÿé¢è¯„è®ºè¯': '#FFB6C1', 
        'æ—…æ¸¸è¦ç´ ': '#FFA500',
        'æ‹“å±•è¦ç´ ': '#FFE4B5'
      };
      return colorMap[nodeType] || '#808080';
    }
    
    // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', function() {
      // åˆå§‹åŒ–å›¾è¡¨
      try {
        chart = echarts.init(document.getElementById('main'));
        showStatus('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·å…ˆä¸‹è½½æ•°æ®æ¨¡ç‰ˆï¼Œç„¶åä¸Šä¼ Excelæ–‡ä»¶', 'info');
        
        // æ˜¾ç¤ºç¤ºä¾‹å›¾è¡¨
        const sampleData = {
          nodes: [
            {id: 'è¥¿æ¹–', name: 'è¥¿æ¹–', category: 0, itemStyle: {color: '#000000'}},
            {id: 'ç¾ä¸½', name: 'ç¾ä¸½', category: 1, itemStyle: {color: '#87CEEB'}},
            {id: 'è´µ', name: 'è´µ', category: 2, itemStyle: {color: '#FFB6C1'}},
            {id: 'è‡ªç„¶æ™¯è§‚', name: 'è‡ªç„¶æ™¯è§‚', category: 3, itemStyle: {color: '#FFA500'}},
            {id: 'å£®è§‚', name: 'å£®è§‚', category: 1, itemStyle: {color: '#87CEEB'}}
          ],
          links: [
            {source: 'è¥¿æ¹–', target: 'ç¾ä¸½', name: 'æ­£é¢è¯„ä»·'},
            {source: 'è¥¿æ¹–', target: 'è´µ', name: 'è´Ÿé¢è¯„ä»·'},
            {source: 'è¥¿æ¹–', target: 'è‡ªç„¶æ™¯è§‚', name: 'åŒ…å«è¦ç´ '},
            {source: 'è‡ªç„¶æ™¯è§‚', target: 'å£®è§‚', name: 'æ­£é¢å…³è”'},
            {source: 'ç¾ä¸½', target: 'å£®è§‚', name: 'æƒ…æ„Ÿå…³è”'}
          ]
        };
        
        chart.setOption({
          title: {
            text: 'è¯­ä¹‰ç½‘ç»œå›¾ç¤ºä¾‹',
            left: 'center',
            textStyle: {
              fontSize: 20,
              fontWeight: 'bold'
            }
          },
          tooltip: {
            trigger: 'item',
            formatter: function(params) {
              if (params.dataType === 'node') {
                return `èŠ‚ç‚¹: ${params.name}<br/>ç±»å‹: ${params.data.nodeType || 'ç¤ºä¾‹èŠ‚ç‚¹'}`;
              } else {
                return `å…³ç³»: ${params.data.source} â†’ ${params.data.target}<br/>ç±»å‹: ${params.data.name}`;
              }
            }
          },
          legend: {
            data: ['æ—…æ¸¸åœ°', 'æ­£é¢è¯„è®ºè¯', 'è´Ÿé¢è¯„è®ºè¯', 'æ—…æ¸¸è¦ç´ '],
            top: 'bottom',
            itemGap: 20
          },
          series: [{
            type: 'graph',
            layout: 'force',
            roam: true,
            categories: [
              {name: 'æ—…æ¸¸åœ°'},
              {name: 'æ­£é¢è¯„è®ºè¯'},
              {name: 'è´Ÿé¢è¯„è®ºè¯'},
              {name: 'æ—…æ¸¸è¦ç´ '}
            ],
            data: sampleData.nodes,
            links: sampleData.links,
            label: {
              show: true,
              position: 'right',
              formatter: '{b}',
              fontSize: 12
            },
            force: {
              repulsion: 400,
              edgeLength: 200,
              gravity: 0.1
            },
            emphasis: {
              focus: 'adjacency',
              lineStyle: {
                width: 3
              }
            },
            lineStyle: {
              color: 'source',
              curveness: 0.1,
              width: 2
            }
          }]
        });
        
      } catch (error) {
        showStatus('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
      }
    });

    // æ–‡ä»¶ä¸Šä¼ å¤„ç†
    document.getElementById('file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      showStatus('æ­£åœ¨è¯»å–æ–‡ä»¶...', 'info');
      
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          
          if (workbook.SheetNames.length === 0) {
            showStatus('Excel æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°å·¥ä½œè¡¨', 'error');
            return;
          }
          
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
          
          if (json.length < 2) {
            showStatus('Excel æ–‡ä»¶æ•°æ®ä¸è¶³ï¼Œè‡³å°‘éœ€è¦è¡¨å¤´å’Œä¸€è¡Œæ•°æ®ã€‚è¯·ä¸‹è½½æ•°æ®æ¨¡ç‰ˆå‚è€ƒæ ¼å¼', 'error');
            return;
          }
          
          // éªŒè¯è¡¨å¤´æ ¼å¼
          const headers = json[0];
          const expectedHeaders = ['èŠ‚ç‚¹A', 'èŠ‚ç‚¹B', 'å…³ç³»ç±»å‹', 'èŠ‚ç‚¹Aç±»å‹', 'èŠ‚ç‚¹Bç±»å‹'];
          const headersMatch = expectedHeaders.every((header, index) => 
            headers[index] && headers[index].toString().trim() === header
          );
          
          if (!headersMatch) {
            showStatus('è¡¨å¤´æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä½¿ç”¨æ ‡å‡†æ¨¡ç‰ˆã€‚åº”åŒ…å«ï¼šèŠ‚ç‚¹A, èŠ‚ç‚¹B, å…³ç³»ç±»å‹, èŠ‚ç‚¹Aç±»å‹, èŠ‚ç‚¹Bç±»å‹', 'error');
            return;
          }
          
          showStatus('æ­£åœ¨ç”Ÿæˆç½‘ç»œå›¾...', 'info');
          
          // è§£ææ•°æ®
          let nodes = {}, links = [];
          let categories = new Set();
          let nodeTypes = {}; // å­˜å‚¨èŠ‚ç‚¹ç±»å‹
          
          json.forEach((row, i) => {
            if (i === 0) return; // è·³è¿‡è¡¨å¤´
            if (!row || row.length < 5) return; // è·³è¿‡æ•°æ®ä¸å®Œæ•´çš„è¡Œ
            
            const [nodeA, nodeB, relationType, nodeAType, nodeBType] = row.map(cell => 
              cell ? cell.toString().trim() : ''
            );
            
            if (!nodeA || !nodeB || !nodeAType || !nodeBType) return; // è·³è¿‡ç©ºå€¼
            
            // è®°å½•èŠ‚ç‚¹ç±»å‹
            nodeTypes[nodeA] = nodeAType;
            nodeTypes[nodeB] = nodeBType;
            
            categories.add(nodeAType);
            categories.add(nodeBType);
            
            // åˆ›å»ºèŠ‚ç‚¹
            if (!nodes[nodeA]) {
              nodes[nodeA] = {
                id: nodeA,
                name: nodeA,
                category: nodeAType,
                nodeType: nodeAType,
                itemStyle: {
                  color: getNodeColor(nodeAType)
                }
              };
            }
            if (!nodes[nodeB]) {
              nodes[nodeB] = {
                id: nodeB,
                name: nodeB,
                category: nodeBType,
                nodeType: nodeBType,
                itemStyle: {
                  color: getNodeColor(nodeBType)
                }
              };
            }
            
            // åˆ›å»ºè¿æ¥
            links.push({
              source: nodeA,
              target: nodeB,
              name: relationType || 'å…³è”',
              value: relationType
            });
          });
          
          if (Object.keys(nodes).length === 0) {
            showStatus('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠ‚ç‚¹æ•°æ®ï¼Œè¯·æ£€æŸ¥æ•°æ®æ ¼å¼', 'error');
            return;
          }
          
          const categoryArray = Array.from(categories).map(cat => ({name: cat}));
          
          // æ›´æ–°å›¾è¡¨
          chart.setOption({
            title: {
              text: 'è¯­ä¹‰ç½‘ç»œå›¾',
              left: 'center',
              textStyle: {
                fontSize: 20,
                fontWeight: 'bold'
              }
            },
            tooltip: {
              trigger: 'item',
              formatter: function(params) {
                if (params.dataType === 'node') {
                  return `èŠ‚ç‚¹: ${params.name}<br/>ç±»å‹: ${params.data.nodeType}`;
                } else {
                  return `å…³ç³»: ${params.data.source} â†’ ${params.data.target}<br/>ç±»å‹: ${params.data.name}`;
                }
              }
            },
            legend: {
              data: categoryArray.map(c => c.name),
              top: 'bottom',
              itemGap: 20
            },
            series: [{
              type: 'graph',
              layout: 'force',
              roam: true,
              categories: categoryArray,
              data: Object.values(nodes),
              links: links,
              label: {
                show: true,
                position: 'right',
                formatter: '{b}',
                fontSize: 12
              },
              force: {
                repulsion: 400,
                edgeLength: 200,
                gravity: 0.1
              },
              emphasis: {
                focus: 'adjacency',
                lineStyle: {
                  width: 3
                }
              },
              lineStyle: {
                color: 'source',
                curveness: 0.1,
                width: 2
              }
            }]
          });
          
          showStatus(`âœ… æˆåŠŸç”Ÿæˆç½‘ç»œå›¾ï¼èŠ‚ç‚¹æ•°: ${Object.keys(nodes).length}, è¾¹æ•°: ${links.length}`, 'success');
          document.getElementById('download').style.display = 'inline-block';
          
        } catch (error) {
          showStatus('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message + 'ã€‚è¯·ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„Excelæ ¼å¼', 'error');
        }
      };
      
      reader.onerror = function() {
        showStatus('æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      };
      
      reader.readAsArrayBuffer(file);
    });

    // ä¸‹è½½å›¾ç‰‡
    document.getElementById('download').onclick = function() {
      try {
        const url = chart.getDataURL({
          type: 'png',
          pixelRatio: 2,
          backgroundColor: '#fff'
        });
        const a = document.createElement('a');
        a.href = url;
        a.download = 'semantic-network-graph.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showStatus('ğŸ–¼ï¸ å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼', 'success');
      } catch (error) {
        showStatus('å›¾ç‰‡ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
      }
    };
  </script>
</body>
</html>
