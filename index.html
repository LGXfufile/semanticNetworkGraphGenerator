<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­ä¹‰ç½‘ç»œå›¾ç”Ÿæˆå™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 16px;
    }
    
    .upload-section {
      margin-bottom: 30px;
      padding: 25px;
      border: 2px dashed #007bff;
      border-radius: 8px;
      text-align: center;
      background: #f8f9ff;
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      min-width: 120px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #1e7e34, #155724);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6c757d, #545b62);
      color: white;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #545b62, #3d4349);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .file-input-wrapper label {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 500;
      min-width: 120px;
      text-align: center;
    }
    
    .file-input-wrapper label:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .background-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .background-controls label {
      font-weight: 500;
      color: #333;
      margin-right: 10px;
    }
    
    .background-btn {
      padding: 8px 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
      color: #333;
      min-width: 80px;
      text-align: center;
    }
    
    .background-btn:hover {
      border-color: #007bff;
      background: #f8f9ff;
    }
    
    .background-btn.active {
      border-color: #007bff;
      background: #007bff;
      color: white;
    }
    
    .chart-container {
      flex: 1;
      min-height: 500px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      margin-bottom: 20px;
    }
    
    .status {
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: 500;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }
    
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 14px;
      display: none;
    }
    
    .debug-info h4 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .debug-info pre {
      background: white;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      color: #666;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .button-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .background-controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .background-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ•¸ï¸ è¯­ä¹‰ç½‘ç»œå›¾ç”Ÿæˆå™¨</h1>
      <p>ä¸Šä¼ Excelæ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆç‚«é…·çš„è¯­ä¹‰ç½‘ç»œå›¾</p>
    </div>
    
    <div class="upload-section">
      <div class="button-group">
        <div class="file-input-wrapper">
          <input type="file" id="file" accept=".xlsx,.xls">
          <label for="file">ğŸ“ é€‰æ‹©Excelæ–‡ä»¶</label>
        </div>
        <a href="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,UEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAALAAAAZGVmYXVsdC54bHNQSwMEFAAACAgA1omTVgAAAAAAAAAAAAAAAA8AAAB4bC9yZWxzLy5yZWxzUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAAaAAAAeGwvX3JlbHMvd29ya2Jvb2sueG1sLnJlbHNQSwMEFAAACAgA1omTVgAAAAAAAAAAAAAAAA8AAAB4bC93b3JrYm9vay54bWxQSwMEFAAACAgA1omTVgAAAAAAAAAAAAAAAA0AAAB4bC9zdHlsZXMueG1sUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAAYAAAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAAaAAAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAATAAAAeGwvdGhlbWUvdGhlbWUxLnhtbFBLAQItABQAAAAIANaJk1YAAAAAAAAAAAAAAAALAAAAAAAAAAAAAAAAAAAAZGVmYXVsdC54bHNQSwECLQAUAAAICADWiZNWAAAAAAAAAAAAAAAADwAAAAAAAAAAAAAAACoAAAB4bC9yZWxzLy5yZWxzUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABoAAAAAAAAAAAAAAABYAAAAeGwvX3JlbHMvd29ya2Jvb2sueG1sLnJlbHNQSwECLQAUAAAICADWiZNWAAAAAAAAAAAAAAAADwAAAAAAAAAAAAAAAJEAAAB4bC93b3JrYm9vay54bWxQSwECLQAUAAAICADWiZNWAAAAAAAAAAAAAAAADQAAAAAAAAAAAAAAAL8AAAB4bC9zdHlsZXMueG1sUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABgAAAAAAAAAAAAAAADrAAAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABoAAAAAAAAAAAAAAAAiAQAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABMAAAAAAAAAAAAAAABbAQAAeGwvdGhlbWUvdGhlbWUxLnhtbFBLBQYAAAAACAAIAOcBAACtAQAAAAA=" download="è¯­ä¹‰ç½‘ç»œå›¾æ¨¡æ¿.xlsx" class="btn btn-secondary">ğŸ“¥ ä¸‹è½½æ¨¡æ¿</a>
        <button id="download" class="btn btn-success" style="display: none;">ğŸ’¾ ä¸‹è½½å›¾ç‰‡</button>
      </div>
      
      <div class="background-controls">
        <label>å›¾è¡¨èƒŒæ™¯:</label>
        <button class="background-btn active" onclick="changeBackground('transparent')">æ— åº•è‰²</button>
        <button class="background-btn" onclick="changeBackground('#ffffff')">ç™½è‰²</button>
        <button class="background-btn" onclick="changeBackground('#f0f8ff')">æ·¡è“</button>
        <button class="background-btn" onclick="changeBackground('#f5f5dc')">ç±³è‰²</button>
        <button class="background-btn" onclick="changeBackground('#000000')">é»‘è‰²</button>
      </div>
    </div>
    
    <div id="status" class="status"></div>
    
    <div id="chart" class="chart-container"></div>
    
    <div id="debug" class="debug-info">
      <h4>ğŸ“Š è°ƒè¯•ä¿¡æ¯</h4>
      <pre id="debug-content"></pre>
    </div>
    
    <div class="footer">
      <p>ğŸ’¡ æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼šExcel (.xlsx, .xls) | æ•°æ®æ ¼å¼ï¼šèŠ‚ç‚¹A | èŠ‚ç‚¹B | å…³ç³» | ç±»å‹A | ç±»å‹B</p>
      <p>ğŸ¨ æ‹–æ‹½èŠ‚ç‚¹å¯è°ƒæ•´ä½ç½®ï¼Œæ»šè½®å¯ç¼©æ”¾ï¼Œç‚¹å‡»èŠ‚ç‚¹å¯æŸ¥çœ‹è¯¦æƒ…</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    let chart;
    let animationInterval;
    let currentBackground = 'transparent';
    
    // èŠ‚ç‚¹é¢œè‰²æ˜ å°„
    const colorMap = {
      'æ­£é¢æƒ…æ„Ÿè¯': '#ff6b6b',
      'è´Ÿé¢æƒ…æ„Ÿè¯': '#4ecdc4', 
      'æ—…æ¸¸è¦ç´ ': '#45b7d1',
      'æ—…æ¸¸åœ°': '#96ceb4',
      'æ™¯ç‚¹': '#ffeaa7',
      'æœåŠ¡': '#dda0dd',
      'è®¾æ–½': '#98d8c8',
      'æ´»åŠ¨': '#f7dc6f',
      'é»˜è®¤ç±»å‹': '#95a5a6'
    };
    
    // è·å–èŠ‚ç‚¹é¢œè‰²
    function getNodeColor(type) {
      return colorMap[type] || colorMap['é»˜è®¤ç±»å‹'];
    }
    
    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
    
    // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    function showDebugInfo(info) {
      const debugDiv = document.getElementById('debug');
      const debugContent = document.getElementById('debug-content');
      debugContent.textContent = JSON.stringify(info, null, 2);
      debugDiv.style.display = 'block';
    }
    
    // å‘é€é€šçŸ¥
    async function sendNotification(type, data) {
      try {
        const response = await fetch('/api/notify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: type,
            data: data,
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          console.log('âœ… é€šçŸ¥å‘é€æˆåŠŸ');
        } else {
          console.warn('âš ï¸ é€šçŸ¥å‘é€å¤±è´¥:', response.status);
        }
      } catch (error) {
        console.warn('âš ï¸ é€šçŸ¥å‘é€é”™è¯¯:', error);
      }
    }
    
    // åˆ‡æ¢èƒŒæ™¯
    function changeBackground(bg) {
      currentBackground = bg;
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.background-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // æ›´æ–°å›¾è¡¨èƒŒæ™¯
      updateChartBackground();
    }
    
    // æ›´æ–°å›¾è¡¨èƒŒæ™¯
    function updateChartBackground() {
      if (!chart) return;
      
      const option = chart.getOption();
      option.backgroundColor = currentBackground;
      chart.setOption(option);
    }
    
    // åˆå§‹åŒ–å›¾è¡¨
    function initChart() {
      const chartDom = document.getElementById('chart');
      chart = echarts.init(chartDom);
      
      // åˆ›å»ºç¤ºä¾‹æ•°æ®
      const exampleData = {
        nodes: [
          { id: 'è¥¿æ¹–', name: 'è¥¿æ¹–', nodeType: 'æ—…æ¸¸åœ°', value: 80, category: 0 },
          { id: 'ç¾ä¸½', name: 'ç¾ä¸½', nodeType: 'æ­£é¢æƒ…æ„Ÿè¯', value: 60, category: 1 },
          { id: 'å£®è§‚', name: 'å£®è§‚', nodeType: 'æ­£é¢æƒ…æ„Ÿè¯', value: 55, category: 1 },
          { id: 'æ‹¥æŒ¤', name: 'æ‹¥æŒ¤', nodeType: 'è´Ÿé¢æƒ…æ„Ÿè¯', value: 45, category: 2 },
          { id: 'å˜ˆæ‚', name: 'å˜ˆæ‚', nodeType: 'è´Ÿé¢æƒ…æ„Ÿè¯', value: 40, category: 2 },
          { id: 'æ–­æ¡¥', name: 'æ–­æ¡¥', nodeType: 'æ™¯ç‚¹', value: 65, category: 3 },
          { id: 'é›·å³°å¡”', name: 'é›·å³°å¡”', nodeType: 'æ™¯ç‚¹', value: 70, category: 3 },
          { id: 'è‹å ¤', name: 'è‹å ¤', nodeType: 'æ™¯ç‚¹', value: 60, category: 3 },
          { id: 'æ¸¸èˆ¹', name: 'æ¸¸èˆ¹', nodeType: 'æ—…æ¸¸è¦ç´ ', value: 50, category: 4 },
          { id: 'é—¨ç¥¨', name: 'é—¨ç¥¨', nodeType: 'æ—…æ¸¸è¦ç´ ', value: 45, category: 4 },
          { id: 'å¯¼æ¸¸', name: 'å¯¼æ¸¸', nodeType: 'æœåŠ¡', value: 55, category: 5 },
          { id: 'é¤é¥®', name: 'é¤é¥®', nodeType: 'æœåŠ¡', value: 50, category: 5 },
          { id: 'åœè½¦åœº', name: 'åœè½¦åœº', nodeType: 'è®¾æ–½', value: 40, category: 6 },
          { id: 'æ´—æ‰‹é—´', name: 'æ´—æ‰‹é—´', nodeType: 'è®¾æ–½', value: 35, category: 6 },
          { id: 'æ‘„å½±', name: 'æ‘„å½±', nodeType: 'æ´»åŠ¨', value: 60, category: 7 },
          { id: 'åˆ’èˆ¹', name: 'åˆ’èˆ¹', nodeType: 'æ´»åŠ¨', value: 55, category: 7 }
        ],
        links: [
          { source: 'è¥¿æ¹–', target: 'ç¾ä¸½', relation: 'å…·æœ‰ç‰¹å¾' },
          { source: 'è¥¿æ¹–', target: 'å£®è§‚', relation: 'å…·æœ‰ç‰¹å¾' },
          { source: 'è¥¿æ¹–', target: 'æ‹¥æŒ¤', relation: 'å­˜åœ¨é—®é¢˜' },
          { source: 'è¥¿æ¹–', target: 'å˜ˆæ‚', relation: 'å­˜åœ¨é—®é¢˜' },
          { source: 'è¥¿æ¹–', target: 'æ–­æ¡¥', relation: 'åŒ…å«æ™¯ç‚¹' },
          { source: 'è¥¿æ¹–', target: 'é›·å³°å¡”', relation: 'åŒ…å«æ™¯ç‚¹' },
          { source: 'è¥¿æ¹–', target: 'è‹å ¤', relation: 'åŒ…å«æ™¯ç‚¹' },
          { source: 'è¥¿æ¹–', target: 'æ¸¸èˆ¹', relation: 'æä¾›æœåŠ¡' },
          { source: 'è¥¿æ¹–', target: 'é—¨ç¥¨', relation: 'éœ€è¦' },
          { source: 'æ–­æ¡¥', target: 'ç¾ä¸½', relation: 'å…·æœ‰ç‰¹å¾' },
          { source: 'é›·å³°å¡”', target: 'å£®è§‚', relation: 'å…·æœ‰ç‰¹å¾' },
          { source: 'è‹å ¤', target: 'ç¾ä¸½', relation: 'å…·æœ‰ç‰¹å¾' },
          { source: 'æ¸¸èˆ¹', target: 'åˆ’èˆ¹', relation: 'æä¾›æ´»åŠ¨' },
          { source: 'å¯¼æ¸¸', target: 'æœåŠ¡', relation: 'å±äº' },
          { source: 'é¤é¥®', target: 'æœåŠ¡', relation: 'å±äº' },
          { source: 'åœè½¦åœº', target: 'è®¾æ–½', relation: 'å±äº' },
          { source: 'æ´—æ‰‹é—´', target: 'è®¾æ–½', relation: 'å±äº' },
          { source: 'æ‘„å½±', target: 'æ´»åŠ¨', relation: 'å±äº' },
          { source: 'åˆ’èˆ¹', target: 'æ´»åŠ¨', relation: 'å±äº' }
        ],
        categories: [
          { name: 'æ—…æ¸¸åœ°', itemStyle: { color: getNodeColor('æ—…æ¸¸åœ°') } },
          { name: 'æ­£é¢æƒ…æ„Ÿè¯', itemStyle: { color: getNodeColor('æ­£é¢æƒ…æ„Ÿè¯') } },
          { name: 'è´Ÿé¢æƒ…æ„Ÿè¯', itemStyle: { color: getNodeColor('è´Ÿé¢æƒ…æ„Ÿè¯') } },
          { name: 'æ™¯ç‚¹', itemStyle: { color: getNodeColor('æ™¯ç‚¹') } },
          { name: 'æ—…æ¸¸è¦ç´ ', itemStyle: { color: getNodeColor('æ—…æ¸¸è¦ç´ ') } },
          { name: 'æœåŠ¡', itemStyle: { color: getNodeColor('æœåŠ¡') } },
          { name: 'è®¾æ–½', itemStyle: { color: getNodeColor('è®¾æ–½') } },
          { name: 'æ´»åŠ¨', itemStyle: { color: getNodeColor('æ´»åŠ¨') } }
        ]
      };
      
      // ä¸ºèŠ‚ç‚¹æ·»åŠ é¢œè‰²
      exampleData.nodes.forEach(node => {
        node.itemStyle = { color: getNodeColor(node.nodeType) };
      });
      
      // ä¸ºè¿çº¿æ·»åŠ é¢œè‰²
      exampleData.links.forEach(link => {
        const sourceNode = exampleData.nodes.find(n => n.id === link.source);
        link.lineStyle = {
          color: sourceNode ? getNodeColor(sourceNode.nodeType) : '#999',
          width: 2
        };
      });
      
      updateChart(exampleData);
      
      console.log('âœ… å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
    }
    
    // æ›´æ–°å›¾è¡¨
    function updateChart(graphData) {
      if (!chart) {
        console.error('âŒ å›¾è¡¨æœªåˆå§‹åŒ–');
        return;
      }
      
      console.log('ğŸ“Š æ›´æ–°å›¾è¡¨æ•°æ®:', graphData);
      
      // æ¸…é™¤ä¹‹å‰çš„åŠ¨ç”»
      if (animationInterval) {
        clearInterval(animationInterval);
      }
      
      // é…ç½®å›¾è¡¨é€‰é¡¹
      const option = {
        backgroundColor: currentBackground,
        title: {
          text: 'è¯­ä¹‰ç½‘ç»œå›¾',
          left: 'center',
          top: 20,
          textStyle: {
            color: '#333',
            fontSize: 20,
            fontWeight: 'bold'
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.dataType === 'node') {
              return `<div style="font-size: 14px;">
                <strong>${params.data.name}</strong><br/>
                ç±»å‹: ${params.data.nodeType}<br/>
                è¿æ¥æ•°: ${params.data.value}
              </div>`;
            } else if (params.dataType === 'edge') {
              return `<div style="font-size: 14px;">
                <strong>${params.data.source}</strong> â†’ <strong>${params.data.target}</strong><br/>
                å…³ç³»: ${params.data.relation || 'å…³è”'}
              </div>`;
            }
          }
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          top: 'center',
          data: graphData.categories.map(cat => cat.name),
          textStyle: {
            color: '#333'
          }
        },
        series: [{
          name: 'è¯­ä¹‰ç½‘ç»œ',
          type: 'graph',
          layout: 'force',
          data: graphData.nodes,
          links: graphData.links,
          categories: graphData.categories,
          roam: true,
          label: {
            show: true,
            position: 'right',
            formatter: '{b}',
            fontSize: 12,
            color: '#333'
          },
          labelLayout: {
            hideOverlap: true
          },
          scaleLimit: {
            min: 0.4,
            max: 2
          },
          lineStyle: {
            color: 'source',
            curveness: 0.3,
            width: 2
          },
          emphasis: {
            focus: 'adjacency',
            lineStyle: {
              width: 4
            }
          },
          force: {
            repulsion: 1000,
            gravity: 0.1,
            edgeLength: [50, 200],
            layoutAnimation: true
          },
          animationDuration: 1500,
          animationEasing: 'cubicInOut'
        }]
      };
      
      // è®¾ç½®å›¾è¡¨é€‰é¡¹
      chart.setOption(option, true);
      
      // å¯åŠ¨èŠ‚ç‚¹åŠ¨ç”»æ•ˆæœ
      startNodeAnimation();
      
      console.log('âœ… å›¾è¡¨æ›´æ–°å®Œæˆ');
    }
    
    // å¯åŠ¨èŠ‚ç‚¹åŠ¨ç”»æ•ˆæœ
    function startNodeAnimation() {
      if (animationInterval) {
        clearInterval(animationInterval);
      }
      
      let animationStep = 0;
      animationInterval = setInterval(() => {
        animationStep++;
        
        // è·å–å½“å‰é€‰é¡¹
        const currentOption = chart.getOption();
        if (!currentOption.series || !currentOption.series[0]) return;
        
        const series = currentOption.series[0];
        if (!series.data) return;
        
        // æ›´æ–°èŠ‚ç‚¹åŠ¨ç”»æ•ˆæœ
        series.data.forEach((node, index) => {
          const phase = (animationStep + index * 10) * 0.1;
          const scale = 1 + Math.sin(phase) * 0.1;
          
          node.symbolSize = (node.value || 50) * scale;
          
          // æ·»åŠ å‘¼å¸æ•ˆæœ
          if (node.itemStyle) {
            const alpha = 0.7 + Math.sin(phase) * 0.3;
            const color = node.itemStyle.color;
            if (typeof color === 'string') {
              node.itemStyle.color = color.replace(/rgba?\([^)]+\)/, 
                color.includes('rgb') ? 
                  color.replace(/[\d.]+\)$/, alpha + ')') : 
                  color + Math.floor(alpha * 255).toString(16).padStart(2, '0')
              );
            }
          }
        });
        
        // æ›´æ–°è¿çº¿åŠ¨ç”»æ•ˆæœ
        if (series.links) {
          series.links.forEach((link, index) => {
            const phase = (animationStep + index * 5) * 0.05;
            const opacity = 0.6 + Math.sin(phase) * 0.4;
            
            if (link.lineStyle) {
              link.lineStyle.opacity = opacity;
            }
          });
        }
        
        // æ›´æ–°å›¾è¡¨
        chart.setOption({
          series: [series]
        }, false);
        
      }, 100);
    }
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('ğŸ“ é€‰æ‹©çš„æ–‡ä»¶:', file.name, file.size, 'bytes');
      
      showStatus('æ­£åœ¨å¤„ç†æ–‡ä»¶...', 'info');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          console.log('ğŸ“– å¼€å§‹è¯»å–æ–‡ä»¶...');
          
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          console.log('ğŸ“Š è§£æçš„æ•°æ®:', jsonData);
          
          if (jsonData.length < 2) {
            throw new Error('æ–‡ä»¶æ•°æ®ä¸è¶³ï¼Œè¯·ç¡®ä¿è‡³å°‘æœ‰æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®');
          }
          
          // å¤„ç†æ•°æ®
          const graphData = processExcelData(jsonData);
          
          if (graphData.nodes.length === 0) {
            throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠ‚ç‚¹æ•°æ®');
          }
          
          // æ›´æ–°å›¾è¡¨
          updateChart(graphData);
          
          // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
          const downloadBtn = document.getElementById('download');
          if (downloadBtn) {
            downloadBtn.style.display = 'inline-block';
          }
          
          showStatus(`æ–‡ä»¶å¤„ç†æˆåŠŸï¼ç”Ÿæˆäº† ${graphData.nodes.length} ä¸ªèŠ‚ç‚¹å’Œ ${graphData.links.length} ä¸ªè¿æ¥`, 'success');
          
          // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
          showDebugInfo({
            fileName: file.name,
            totalRows: jsonData.length,
            validRows: jsonData.length - 1,
            nodeCount: graphData.nodes.length,
            linkCount: graphData.links.length,
            categories: graphData.categories.map(cat => cat.name)
          });
          
          // å‘é€ä¸Šä¼ é€šçŸ¥
          sendNotification('file_upload', {
            fileName: file.name,
            fileSize: file.size,
            nodeCount: graphData.nodes.length,
            linkCount: graphData.links.length
          });
          
        } catch (error) {
          console.error('âŒ æ–‡ä»¶å¤„ç†é”™è¯¯:', error);
          showStatus('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message, 'error');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }
    
    // å¤„ç†Excelæ•°æ®
    function processExcelData(jsonData) {
      const headers = jsonData[0];
      const dataRows = jsonData.slice(1);
      
      console.log('ğŸ“‹ è¡¨å¤´:', headers);
      console.log('ğŸ“‹ æ•°æ®è¡Œæ•°:', dataRows.length);
      
      const nodes = new Map();
      const links = [];
      const categorySet = new Set();
      
      dataRows.forEach((row, index) => {
        if (row.length < 2) return;
        
        const nodeA = row[0];
        const nodeB = row[1];
        const relation = row[2] || 'å…³è”';
        const typeA = row[3] || 'é»˜è®¤ç±»å‹';
        const typeB = row[4] || 'é»˜è®¤ç±»å‹';
        
        if (!nodeA || !nodeB) return;
        
        // æ·»åŠ èŠ‚ç‚¹
        if (!nodes.has(nodeA)) {
          nodes.set(nodeA, {
            id: nodeA,
            name: nodeA,
            nodeType: typeA,
            value: 50,
            itemStyle: { color: getNodeColor(typeA) }
          });
          categorySet.add(typeA);
        }
        
        if (!nodes.has(nodeB)) {
          nodes.set(nodeB, {
            id: nodeB,
            name: nodeB,
            nodeType: typeB,
            value: 50,
            itemStyle: { color: getNodeColor(typeB) }
          });
          categorySet.add(typeB);
        }
        
        // æ·»åŠ è¿æ¥
        links.push({
          source: nodeA,
          target: nodeB,
          value: 5,
          relation: relation,
          lineStyle: {
            color: getNodeColor(typeA),
            width: 2
          }
        });
      });
      
      // è®¾ç½®åˆ†ç±»
      const categories = Array.from(categorySet).map((type, index) => ({
        name: type,
        itemStyle: { color: getNodeColor(type) }
      }));
      
      // ä¸ºèŠ‚ç‚¹è®¾ç½®åˆ†ç±»ç´¢å¼•
      const nodeArray = Array.from(nodes.values()).map(node => {
        const categoryIndex = categories.findIndex(cat => cat.name === node.nodeType);
        return {
          ...node,
          category: categoryIndex >= 0 ? categoryIndex : 0
        };
      });
      
      return {
        nodes: nodeArray,
        links: links,
        categories: categories
      };
    }
    
    // ä¸‹è½½å›¾ç‰‡
    function downloadImage() {
      if (!chart) {
        showStatus('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ç”Ÿæˆå›¾è¡¨', 'error');
        return;
      }
      
      try {
        const url = chart.getDataURL({
          pixelRatio: 2,
          backgroundColor: currentBackground === 'transparent' ? '#fff' : currentBackground
        });
        
        const link = document.createElement('a');
        link.download = 'è¯­ä¹‰ç½‘ç»œå›¾.png';
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatus('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼', 'success');
        
        // å‘é€ä¸‹è½½é€šçŸ¥
        sendNotification('image_download', {
          fileName: 'è¯­ä¹‰ç½‘ç»œå›¾.png',
          background: currentBackground
        });
        
      } catch (error) {
        console.error('âŒ å›¾ç‰‡ä¸‹è½½é”™è¯¯:', error);
        showStatus('å›¾ç‰‡ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', function() {
      console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
      
      // åˆå§‹åŒ–å›¾è¡¨
      initChart();
      
      // ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
      const fileInput = document.getElementById('file');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileUpload);
        console.log('âœ… æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç»‘å®šæˆåŠŸ');
      }
      
      // ç»‘å®šä¸‹è½½æŒ‰é’®äº‹ä»¶
      const downloadBtn = document.getElementById('download');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadImage);
        console.log('âœ… ä¸‹è½½æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
      }
      
      console.log('ğŸ‰ æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼');
    });
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†åŠ¨ç”»
    window.addEventListener('beforeunload', function() {
      if (animationInterval) {
        clearInterval(animationInterval);
      }
    });
    
  </script>
</body>
</html>
