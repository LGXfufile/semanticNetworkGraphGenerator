<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>语义网络图生成器</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .upload-section {
      margin-bottom: 30px;
      padding: 25px;
      border: 2px dashed #007bff;
      border-radius: 8px;
      text-align: center;
      background: #f8f9ff;
    }
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background: #007bff;
      color: white;
    }
    .btn-primary:hover {
      background: #0056b3;
      transform: translateY(-2px);
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #1e7e34;
      transform: translateY(-2px);
    }
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
    }
    .btn-warning {
      background: #ffc107;
      color: #212529;
    }
    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-2px);
    }
    #file {
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    #main {
      width: 100%;
      height: 600px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-weight: 500;
    }
    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
    .description {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.6;
    }
    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      color: #999;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🌐 语义网络图生成器</h1>
    <p class="description">
      上传Excel文件，自动生成美观的语义网络图。支持节点分类、关系展示和图片导出功能。
    </p>
    
    <div class="upload-section">
      <div class="button-group">
        <button class="btn btn-info" onclick="downloadTemplate()">📥 下载数据模版</button>
        <input type="file" id="file" accept=".xlsx,.xls" class="btn">
        <button class="btn btn-success" id="download" style="display:none;">🖼️ 下载图片</button>
        <button class="btn btn-warning" onclick="testNotification()">🔔 测试通知</button>
      </div>
      <div id="status"></div>
    </div>
    
    <div id="main"></div>
    
    <div class="footer">
      <p>支持的格式：Excel (.xlsx, .xls) | 生成高质量PNG图片</p>
      <p>© 2025 语义网络图生成器 - 让数据可视化更简单</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    let chart;
    let currentGraphData = null; // 存储当前图表数据
    
    // 修复后的通知发送函数
    async function sendNotification(action, fileInfo = {}) {
      try {
        console.log('🔔 发送通知:', action, fileInfo);
        
        // 使用相对路径，避免域名问题
        const apiUrl = '/api/notify';
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: action,
            fileInfo: fileInfo
          })
        });

        console.log('📡 API响应状态:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('📋 API响应内容:', result);
        
        if (result.success) {
          console.log('✅ 通知发送成功');
        } else {
          console.error('❌ 通知发送失败:', result);
        }
      } catch (error) {
        console.error('🚨 通知发送异常:', error);
        // 不显示错误给用户，避免影响用户体验
      }
    }
    
    // 测试函数
    function testNotification() {
      sendNotification('upload', {
        fileName: '测试文件.xlsx',
        nodeCount: 10,
        linkCount: 15,
        dataRows: 20
      });
      showStatus('测试通知已发送，请检查企业微信', 'info');
    }

    // 模版数据
    const templateData = [
      ['节点A', '节点B', '关系类型', '节点A类型', '节点B类型'],
      ['西湖', '美丽', '正面评价', '旅游地', '正面评论词'],
      ['西湖', '贵', '负面评价', '旅游地', '负面评论词'],
      ['西湖', '自然景观', '包含要素', '旅游地', '旅游要素'],
      ['自然景观', '壮观', '正面关联', '旅游要素', '正面评论词'],
      ['美丽', '壮观', '情感关联', '正面评论词', '正面评论词']
    ];
    
    // 下载数据模版
    function downloadTemplate() {
      try {
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '数据模版');
        
        const colWidths = [
          { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 15 }
        ];
        ws['!cols'] = colWidths;
        
        XLSX.writeFile(wb, '语义网络图数据模版.xlsx');
        showStatus('数据模版下载成功！请按照模版格式填写数据', 'success');
        sendNotification('template_download');
      } catch (error) {
        showStatus('模版下载失败: ' + error.message, 'error');
      }
    }
    
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      if (type === 'error') {
        console.error(message);
      }
    }
    
    function getNodeColor(nodeType) {
      const colorMap = {
        '旅游地': '#000000',
        '正面评论词': '#87CEEB',
        '负面评论词': '#FFB6C1', 
        '旅游要素': '#FFA500',
        '拓展要素': '#FFE4B5'
      };
      return colorMap[nodeType] || '#808080';
    }
    
    // 页面加载完成
    document.addEventListener('DOMContentLoaded', function() {
      try {
        chart = echarts.init(document.getElementById('main'));
        showStatus('页面加载完成，请先下载数据模版，然后上传Excel文件', 'info');
        
        // 显示示例图表
        const sampleData = {
          nodes: [
            {id: '西湖', name: '西湖', category: 0, itemStyle: {color: '#000000'}},
            {id: '美丽', name: '美丽', category: 1, itemStyle: {color: '#87CEEB'}},
            {id: '贵', name: '贵', category: 2, itemStyle: {color: '#FFB6C1'}},
            {id: '自然景观', name: '自然景观', category: 3, itemStyle: {color: '#FFA500'}},
            {id: '壮观', name: '壮观', category: 1, itemStyle: {color: '#87CEEB'}}
          ],
          links: [
            {source: '西湖', target: '美丽', name: '正面评价'},
            {source: '西湖', target: '贵', name: '负面评价'},
            {source: '西湖', target: '自然景观', name: '包含要素'},
            {source: '自然景观', target: '壮观', name: '正面关联'},
            {source: '美丽', target: '壮观', name: '情感关联'}
          ]
        };
        
        chart.setOption({
          title: {
            text: '语义网络图示例',
            left: 'center',
            textStyle: { fontSize: 20, fontWeight: 'bold' }
          },
          tooltip: {
            trigger: 'item',
            formatter: function(params) {
              if (params.dataType === 'node') {
                return `节点: ${params.name}<br/>类型: ${params.data.nodeType || '示例节点'}`;
              } else {
                return `关系: ${params.data.source} → ${params.data.target}<br/>类型: ${params.data.name}`;
              }
            }
          },
          legend: {
            data: ['旅游地', '正面评论词', '负面评论词', '旅游要素'],
            top: 'bottom',
            itemGap: 20
          },
          series: [{
            type: 'graph',
            layout: 'force',
            roam: true,
            categories: [
              {name: '旅游地'}, {name: '正面评论词'}, {name: '负面评论词'}, {name: '旅游要素'}
            ],
            data: sampleData.nodes,
            links: sampleData.links,
            label: { show: true, position: 'right', formatter: '{b}', fontSize: 12 },
            force: { repulsion: 400, edgeLength: 200, gravity: 0.1 },
            emphasis: { focus: 'adjacency', lineStyle: { width: 3 } },
            lineStyle: { color: 'source', curveness: 0.1, width: 2 }
          }]
        });
        
      } catch (error) {
        showStatus('图表初始化失败: ' + error.message, 'error');
      }
    });

    // 文件上传处理
    document.getElementById('file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      showStatus('正在读取文件...', 'info');
      
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          
          if (workbook.SheetNames.length === 0) {
            showStatus('Excel 文件中没有找到工作表', 'error');
            return;
          }
          
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, {header: 1});
          
          if (json.length < 2) {
            showStatus('Excel 文件数据不足，至少需要表头和一行数据。请下载数据模版参考格式', 'error');
            return;
          }
          
          // 验证表头格式
          const headers = json[0];
          const expectedHeaders = ['节点A', '节点B', '关系类型', '节点A类型', '节点B类型'];
          const headersMatch = expectedHeaders.every((header, index) => 
            headers[index] && headers[index].toString().trim() === header
          );
          
          if (!headersMatch) {
            showStatus('表头格式不正确，请使用标准模版。应包含：节点A, 节点B, 关系类型, 节点A类型, 节点B类型', 'error');
            return;
          }
          
          showStatus('正在生成网络图...', 'info');
          
          // 解析数据
          let nodes = {}, links = [];
          let categories = new Set();
          let nodeTypes = {};
          
          json.forEach((row, i) => {
            if (i === 0) return; // 跳过表头
            if (!row || row.length < 5) return; // 跳过数据不完整的行
            
            const [nodeA, nodeB, relationType, nodeAType, nodeBType] = row.map(cell => 
              cell ? cell.toString().trim() : ''
            );
            
            if (!nodeA || !nodeB || !nodeAType || !nodeBType) return; // 跳过空值
            
            // 记录节点类型
            nodeTypes[nodeA] = nodeAType;
            nodeTypes[nodeB] = nodeBType;
            
            categories.add(nodeAType);
            categories.add(nodeBType);
            
            // 创建节点
            if (!nodes[nodeA]) {
              nodes[nodeA] = {
                id: nodeA, name: nodeA, category: nodeAType, nodeType: nodeAType,
                itemStyle: { color: getNodeColor(nodeAType) }
              };
            }
            if (!nodes[nodeB]) {
              nodes[nodeB] = {
                id: nodeB, name: nodeB, category: nodeBType, nodeType: nodeBType,
                itemStyle: { color: getNodeColor(nodeBType) }
              };
            }
            
            // 创建连接
            links.push({
              source: nodeA, target: nodeB, name: relationType || '关联', value: relationType
            });
          });
          
          if (Object.keys(nodes).length === 0) {
            showStatus('没有找到有效的节点数据，请检查数据格式', 'error');
            return;
          }
          
          const categoryArray = Array.from(categories).map(cat => ({name: cat}));
          
          // 保存当前图表数据
          currentGraphData = {
            fileName: file.name,
            nodeCount: Object.keys(nodes).length,
            linkCount: links.length,
            dataRows: json.length - 1
          };
          
          // 更新图表
          chart.setOption({
            title: {
              text: '语义网络图',
              left: 'center',
              textStyle: { fontSize: 20, fontWeight: 'bold' }
            },
            tooltip: {
              trigger: 'item',
              formatter: function(params) {
                if (params.dataType === 'node') {
                  return `节点: ${params.name}<br/>类型: ${params.data.nodeType}`;
                } else {
                  return `关系: ${params.data.source} → ${params.data.target}<br/>类型: ${params.data.name}`;
                }
              }
            },
            legend: {
              data: categoryArray.map(c => c.name),
              top: 'bottom',
              itemGap: 20
            },
            series: [{
              type: 'graph',
              layout: 'force',
              roam: true,
              categories: categoryArray,
              data: Object.values(nodes),
              links: links,
              label: { show: true, position: 'right', formatter: '{b}', fontSize: 12 },
              force: { repulsion: 400, edgeLength: 200, gravity: 0.1 },
              emphasis: { focus: 'adjacency', lineStyle: { width: 3 } },
              lineStyle: { color: 'source', curveness: 0.1, width: 2 }
            }]
          });
          
          showStatus(`✅ 成功生成网络图！节点数: ${Object.keys(nodes).length}, 边数: ${links.length}`, 'success');
          document.getElementById('download').style.display = 'inline-block';
          
          // 发送上传通知
          sendNotification('upload', currentGraphData);
          
        } catch (error) {
          showStatus('文件解析失败: ' + error.message + '。请确保使用正确的Excel格式', 'error');
        }
      };
      
      reader.onerror = function() {
        showStatus('文件读取失败，请重试', 'error');
      };
      
      reader.readAsArrayBuffer(file);
    });

    // 下载图片
    document.getElementById('download').onclick = function() {
      try {
        const url = chart.getDataURL({
          type: 'png',
          pixelRatio: 2,
          backgroundColor: '#fff'
        });
        const a = document.createElement('a');
        a.href = url;
        a.download = 'semantic-network-graph.png';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        showStatus('🖼️ 图片下载成功！', 'success');
        
        // 发送下载通知
        sendNotification('download', currentGraphData);
        
      } catch (error) {
        showStatus('图片下载失败: ' + error.message, 'error');
      }
    };
  </script>
</body>
</html>
