<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>语义网络图生成器</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .header p {
      color: #666;
      font-size: 16px;
    }
    
    .upload-section {
      margin-bottom: 30px;
      padding: 25px;
      border: 2px dashed #007bff;
      border-radius: 8px;
      text-align: center;
      background: #f8f9ff;
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      min-width: 120px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #1e7e34, #155724);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6c757d, #545b62);
      color: white;
    }
    
    .btn-secondary:hover {
      background: linear-gradient(135deg, #545b62, #3d4349);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
    }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .file-input-wrapper label {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 500;
      min-width: 120px;
      text-align: center;
    }
    
    .file-input-wrapper label:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .background-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .background-controls label {
      font-weight: 500;
      color: #333;
      margin-right: 10px;
    }
    
    .background-btn {
      padding: 8px 16px;
      border: 2px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      background: white;
      color: #333;
      min-width: 80px;
      text-align: center;
    }
    
    .background-btn:hover {
      border-color: #007bff;
      background: #f8f9ff;
    }
    
    .background-btn.active {
      border-color: #007bff;
      background: #007bff;
      color: white;
    }
    
    .chart-container {
      flex: 1;
      min-height: 500px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: white;
      margin-bottom: 20px;
    }
    
    .status {
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: 500;
      display: none;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #cce7ff;
      color: #004085;
      border: 1px solid #b3d7ff;
    }
    
    .debug-info {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 15px;
      margin-top: 15px;
      font-family: monospace;
      font-size: 14px;
      display: none;
    }
    
    .debug-info h4 {
      margin-bottom: 10px;
      color: #333;
    }
    
    .debug-info pre {
      background: white;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      color: #666;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .button-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 10px;
      }
      
      .background-controls {
        flex-direction: column;
        gap: 15px;
      }
      
      .background-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🕸️ 语义网络图生成器</h1>
      <p>上传Excel文件，自动生成炫酷的语义网络图</p>
    </div>
    
    <div class="upload-section">
      <div class="button-group">
        <div class="file-input-wrapper">
          <input type="file" id="file" accept=".xlsx,.xls">
          <label for="file">📁 选择Excel文件</label>
        </div>
        <a href="data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,UEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAALAAAAZGVmYXVsdC54bHNQSwMEFAAACAgA1omTVgAAAAAAAAAAAAAAAA8AAAB4bC9yZWxzLy5yZWxzUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAAaAAAAeGwvX3JlbHMvd29ya2Jvb2sueG1sLnJlbHNQSwMEFAAACAgA1omTVgAAAAAAAAAAAAAAAA8AAAB4bC93b3JrYm9vay54bWxQSwMEFAAACAgA1omTVgAAAAAAAAAAAAAAAA0AAAB4bC9zdHlsZXMueG1sUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAAYAAAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAAaAAAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsDBBQAAAAIANaJk1YAAAAAAAAAAAAAAAATAAAAeGwvdGhlbWUvdGhlbWUxLnhtbFBLAQItABQAAAAIANaJk1YAAAAAAAAAAAAAAAALAAAAAAAAAAAAAAAAAAAAZGVmYXVsdC54bHNQSwECLQAUAAAICADWiZNWAAAAAAAAAAAAAAAADwAAAAAAAAAAAAAAACoAAAB4bC9yZWxzLy5yZWxzUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABoAAAAAAAAAAAAAAABYAAAAeGwvX3JlbHMvd29ya2Jvb2sueG1sLnJlbHNQSwECLQAUAAAICADWiZNWAAAAAAAAAAAAAAAADwAAAAAAAAAAAAAAAJEAAAB4bC93b3JrYm9vay54bWxQSwECLQAUAAAICADWiZNWAAAAAAAAAAAAAAAADQAAAAAAAAAAAAAAAL8AAAB4bC9zdHlsZXMueG1sUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABgAAAAAAAAAAAAAAADrAAAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABoAAAAAAAAAAAAAAAAiAQAAeGwvd29ya3NoZWV0cy9zaGVldDEueG1sUEsBAi0AFAAACAgA1omTVgAAAAAAAAAAAAAAABMAAAAAAAAAAAAAAABbAQAAeGwvdGhlbWUvdGhlbWUxLnhtbFBLBQYAAAAACAAIAOcBAACtAQAAAAA=" download="语义网络图模板.xlsx" class="btn btn-secondary">📥 下载模板</a>
        <button id="download" class="btn btn-success" style="display: none;">💾 下载图片</button>
      </div>
      
      <div class="background-controls">
        <label>图表背景:</label>
        <button class="background-btn active" onclick="changeBackground('transparent')">无底色</button>
        <button class="background-btn" onclick="changeBackground('#ffffff')">白色</button>
        <button class="background-btn" onclick="changeBackground('#f0f8ff')">淡蓝</button>
        <button class="background-btn" onclick="changeBackground('#f5f5dc')">米色</button>
        <button class="background-btn" onclick="changeBackground('#000000')">黑色</button>
      </div>
    </div>
    
    <div id="status" class="status"></div>
    
    <div id="chart" class="chart-container"></div>
    
    <div id="debug" class="debug-info">
      <h4>📊 调试信息</h4>
      <pre id="debug-content"></pre>
    </div>
    
    <div class="footer">
      <p>💡 支持的文件格式：Excel (.xlsx, .xls) | 数据格式：节点A | 节点B | 关系 | 类型A | 类型B</p>
      <p>🎨 拖拽节点可调整位置，滚轮可缩放，点击节点可查看详情</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    let chart;
    let animationInterval;
    let currentBackground = 'transparent';
    
    // 节点颜色映射
    const colorMap = {
      '正面情感词': '#ff6b6b',
      '负面情感词': '#4ecdc4', 
      '旅游要素': '#45b7d1',
      '旅游地': '#96ceb4',
      '景点': '#ffeaa7',
      '服务': '#dda0dd',
      '设施': '#98d8c8',
      '活动': '#f7dc6f',
      '默认类型': '#95a5a6'
    };
    
    // 获取节点颜色
    function getNodeColor(type) {
      return colorMap[type] || colorMap['默认类型'];
    }
    
    // 显示状态信息
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
      statusDiv.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }
    }
    
    // 显示调试信息
    function showDebugInfo(info) {
      const debugDiv = document.getElementById('debug');
      const debugContent = document.getElementById('debug-content');
      debugContent.textContent = JSON.stringify(info, null, 2);
      debugDiv.style.display = 'block';
    }
    
    // 发送通知
    async function sendNotification(type, data) {
      try {
        const response = await fetch('/api/notify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            type: type,
            data: data,
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          console.log('✅ 通知发送成功');
        } else {
          console.warn('⚠️ 通知发送失败:', response.status);
        }
      } catch (error) {
        console.warn('⚠️ 通知发送错误:', error);
      }
    }
    
    // 切换背景
    function changeBackground(bg) {
      currentBackground = bg;
      
      // 更新按钮状态
      document.querySelectorAll('.background-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // 更新图表背景
      updateChartBackground();
    }
    
    // 更新图表背景
    function updateChartBackground() {
      if (!chart) return;
      
      const option = chart.getOption();
      option.backgroundColor = currentBackground;
      chart.setOption(option);
    }
    
    // 初始化图表
    function initChart() {
      const chartDom = document.getElementById('chart');
      chart = echarts.init(chartDom);
      
      // 创建示例数据
      const exampleData = {
        nodes: [
          { id: '西湖', name: '西湖', nodeType: '旅游地', value: 80, category: 0 },
          { id: '美丽', name: '美丽', nodeType: '正面情感词', value: 60, category: 1 },
          { id: '壮观', name: '壮观', nodeType: '正面情感词', value: 55, category: 1 },
          { id: '拥挤', name: '拥挤', nodeType: '负面情感词', value: 45, category: 2 },
          { id: '嘈杂', name: '嘈杂', nodeType: '负面情感词', value: 40, category: 2 },
          { id: '断桥', name: '断桥', nodeType: '景点', value: 65, category: 3 },
          { id: '雷峰塔', name: '雷峰塔', nodeType: '景点', value: 70, category: 3 },
          { id: '苏堤', name: '苏堤', nodeType: '景点', value: 60, category: 3 },
          { id: '游船', name: '游船', nodeType: '旅游要素', value: 50, category: 4 },
          { id: '门票', name: '门票', nodeType: '旅游要素', value: 45, category: 4 },
          { id: '导游', name: '导游', nodeType: '服务', value: 55, category: 5 },
          { id: '餐饮', name: '餐饮', nodeType: '服务', value: 50, category: 5 },
          { id: '停车场', name: '停车场', nodeType: '设施', value: 40, category: 6 },
          { id: '洗手间', name: '洗手间', nodeType: '设施', value: 35, category: 6 },
          { id: '摄影', name: '摄影', nodeType: '活动', value: 60, category: 7 },
          { id: '划船', name: '划船', nodeType: '活动', value: 55, category: 7 }
        ],
        links: [
          { source: '西湖', target: '美丽', relation: '具有特征' },
          { source: '西湖', target: '壮观', relation: '具有特征' },
          { source: '西湖', target: '拥挤', relation: '存在问题' },
          { source: '西湖', target: '嘈杂', relation: '存在问题' },
          { source: '西湖', target: '断桥', relation: '包含景点' },
          { source: '西湖', target: '雷峰塔', relation: '包含景点' },
          { source: '西湖', target: '苏堤', relation: '包含景点' },
          { source: '西湖', target: '游船', relation: '提供服务' },
          { source: '西湖', target: '门票', relation: '需要' },
          { source: '断桥', target: '美丽', relation: '具有特征' },
          { source: '雷峰塔', target: '壮观', relation: '具有特征' },
          { source: '苏堤', target: '美丽', relation: '具有特征' },
          { source: '游船', target: '划船', relation: '提供活动' },
          { source: '导游', target: '服务', relation: '属于' },
          { source: '餐饮', target: '服务', relation: '属于' },
          { source: '停车场', target: '设施', relation: '属于' },
          { source: '洗手间', target: '设施', relation: '属于' },
          { source: '摄影', target: '活动', relation: '属于' },
          { source: '划船', target: '活动', relation: '属于' }
        ],
        categories: [
          { name: '旅游地', itemStyle: { color: getNodeColor('旅游地') } },
          { name: '正面情感词', itemStyle: { color: getNodeColor('正面情感词') } },
          { name: '负面情感词', itemStyle: { color: getNodeColor('负面情感词') } },
          { name: '景点', itemStyle: { color: getNodeColor('景点') } },
          { name: '旅游要素', itemStyle: { color: getNodeColor('旅游要素') } },
          { name: '服务', itemStyle: { color: getNodeColor('服务') } },
          { name: '设施', itemStyle: { color: getNodeColor('设施') } },
          { name: '活动', itemStyle: { color: getNodeColor('活动') } }
        ]
      };
      
      // 为节点添加颜色
      exampleData.nodes.forEach(node => {
        node.itemStyle = { color: getNodeColor(node.nodeType) };
      });
      
      // 为连线添加颜色
      exampleData.links.forEach(link => {
        const sourceNode = exampleData.nodes.find(n => n.id === link.source);
        link.lineStyle = {
          color: sourceNode ? getNodeColor(sourceNode.nodeType) : '#999',
          width: 2
        };
      });
      
      updateChart(exampleData);
      
      console.log('✅ 图表初始化完成');
    }
    
    // 更新图表
    function updateChart(graphData) {
      if (!chart) {
        console.error('❌ 图表未初始化');
        return;
      }
      
      console.log('📊 更新图表数据:', graphData);
      
      // 清除之前的动画
      if (animationInterval) {
        clearInterval(animationInterval);
      }
      
      // 配置图表选项
      const option = {
        backgroundColor: currentBackground,
        title: {
          text: '语义网络图',
          left: 'center',
          top: 20,
          textStyle: {
            color: '#333',
            fontSize: 20,
            fontWeight: 'bold'
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.dataType === 'node') {
              return `<div style="font-size: 14px;">
                <strong>${params.data.name}</strong><br/>
                类型: ${params.data.nodeType}<br/>
                连接数: ${params.data.value}
              </div>`;
            } else if (params.dataType === 'edge') {
              return `<div style="font-size: 14px;">
                <strong>${params.data.source}</strong> → <strong>${params.data.target}</strong><br/>
                关系: ${params.data.relation || '关联'}
              </div>`;
            }
          }
        },
        legend: {
          orient: 'vertical',
          left: 'left',
          top: 'center',
          data: graphData.categories.map(cat => cat.name),
          textStyle: {
            color: '#333'
          }
        },
        series: [{
          name: '语义网络',
          type: 'graph',
          layout: 'force',
          data: graphData.nodes,
          links: graphData.links,
          categories: graphData.categories,
          roam: true,
          label: {
            show: true,
            position: 'right',
            formatter: '{b}',
            fontSize: 12,
            color: '#333'
          },
          labelLayout: {
            hideOverlap: true
          },
          scaleLimit: {
            min: 0.4,
            max: 2
          },
          lineStyle: {
            color: 'source',
            curveness: 0.3,
            width: 2
          },
          emphasis: {
            focus: 'adjacency',
            lineStyle: {
              width: 4
            }
          },
          force: {
            repulsion: 1000,
            gravity: 0.1,
            edgeLength: [50, 200],
            layoutAnimation: true
          },
          animationDuration: 1500,
          animationEasing: 'cubicInOut'
        }]
      };
      
      // 设置图表选项
      chart.setOption(option, true);
      
      // 启动节点动画效果
      startNodeAnimation();
      
      console.log('✅ 图表更新完成');
    }
    
    // 启动节点动画效果
    function startNodeAnimation() {
      if (animationInterval) {
        clearInterval(animationInterval);
      }
      
      let animationStep = 0;
      animationInterval = setInterval(() => {
        animationStep++;
        
        // 获取当前选项
        const currentOption = chart.getOption();
        if (!currentOption.series || !currentOption.series[0]) return;
        
        const series = currentOption.series[0];
        if (!series.data) return;
        
        // 更新节点动画效果
        series.data.forEach((node, index) => {
          const phase = (animationStep + index * 10) * 0.1;
          const scale = 1 + Math.sin(phase) * 0.1;
          
          node.symbolSize = (node.value || 50) * scale;
          
          // 添加呼吸效果
          if (node.itemStyle) {
            const alpha = 0.7 + Math.sin(phase) * 0.3;
            const color = node.itemStyle.color;
            if (typeof color === 'string') {
              node.itemStyle.color = color.replace(/rgba?\([^)]+\)/, 
                color.includes('rgb') ? 
                  color.replace(/[\d.]+\)$/, alpha + ')') : 
                  color + Math.floor(alpha * 255).toString(16).padStart(2, '0')
              );
            }
          }
        });
        
        // 更新连线动画效果
        if (series.links) {
          series.links.forEach((link, index) => {
            const phase = (animationStep + index * 5) * 0.05;
            const opacity = 0.6 + Math.sin(phase) * 0.4;
            
            if (link.lineStyle) {
              link.lineStyle.opacity = opacity;
            }
          });
        }
        
        // 更新图表
        chart.setOption({
          series: [series]
        }, false);
        
      }, 100);
    }
    
    // 处理文件上传
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('📁 选择的文件:', file.name, file.size, 'bytes');
      
      showStatus('正在处理文件...', 'info');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          console.log('📖 开始读取文件...');
          
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          
          console.log('📊 解析的数据:', jsonData);
          
          if (jsonData.length < 2) {
            throw new Error('文件数据不足，请确保至少有标题行和一行数据');
          }
          
          // 处理数据
          const graphData = processExcelData(jsonData);
          
          if (graphData.nodes.length === 0) {
            throw new Error('没有找到有效的节点数据');
          }
          
          // 更新图表
          updateChart(graphData);
          
          // 显示下载按钮
          const downloadBtn = document.getElementById('download');
          if (downloadBtn) {
            downloadBtn.style.display = 'inline-block';
          }
          
          showStatus(`文件处理成功！生成了 ${graphData.nodes.length} 个节点和 ${graphData.links.length} 个连接`, 'success');
          
          // 显示调试信息
          showDebugInfo({
            fileName: file.name,
            totalRows: jsonData.length,
            validRows: jsonData.length - 1,
            nodeCount: graphData.nodes.length,
            linkCount: graphData.links.length,
            categories: graphData.categories.map(cat => cat.name)
          });
          
          // 发送上传通知
          sendNotification('file_upload', {
            fileName: file.name,
            fileSize: file.size,
            nodeCount: graphData.nodes.length,
            linkCount: graphData.links.length
          });
          
        } catch (error) {
          console.error('❌ 文件处理错误:', error);
          showStatus('文件处理失败: ' + error.message, 'error');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }
    
    // 处理Excel数据
    function processExcelData(jsonData) {
      const headers = jsonData[0];
      const dataRows = jsonData.slice(1);
      
      console.log('📋 表头:', headers);
      console.log('📋 数据行数:', dataRows.length);
      
      const nodes = new Map();
      const links = [];
      const categorySet = new Set();
      
      dataRows.forEach((row, index) => {
        if (row.length < 2) return;
        
        const nodeA = row[0];
        const nodeB = row[1];
        const relation = row[2] || '关联';
        const typeA = row[3] || '默认类型';
        const typeB = row[4] || '默认类型';
        
        if (!nodeA || !nodeB) return;
        
        // 添加节点
        if (!nodes.has(nodeA)) {
          nodes.set(nodeA, {
            id: nodeA,
            name: nodeA,
            nodeType: typeA,
            value: 50,
            itemStyle: { color: getNodeColor(typeA) }
          });
          categorySet.add(typeA);
        }
        
        if (!nodes.has(nodeB)) {
          nodes.set(nodeB, {
            id: nodeB,
            name: nodeB,
            nodeType: typeB,
            value: 50,
            itemStyle: { color: getNodeColor(typeB) }
          });
          categorySet.add(typeB);
        }
        
        // 添加连接
        links.push({
          source: nodeA,
          target: nodeB,
          value: 5,
          relation: relation,
          lineStyle: {
            color: getNodeColor(typeA),
            width: 2
          }
        });
      });
      
      // 设置分类
      const categories = Array.from(categorySet).map((type, index) => ({
        name: type,
        itemStyle: { color: getNodeColor(type) }
      }));
      
      // 为节点设置分类索引
      const nodeArray = Array.from(nodes.values()).map(node => {
        const categoryIndex = categories.findIndex(cat => cat.name === node.nodeType);
        return {
          ...node,
          category: categoryIndex >= 0 ? categoryIndex : 0
        };
      });
      
      return {
        nodes: nodeArray,
        links: links,
        categories: categories
      };
    }
    
    // 下载图片
    function downloadImage() {
      if (!chart) {
        showStatus('请先上传文件生成图表', 'error');
        return;
      }
      
      try {
        const url = chart.getDataURL({
          pixelRatio: 2,
          backgroundColor: currentBackground === 'transparent' ? '#fff' : currentBackground
        });
        
        const link = document.createElement('a');
        link.download = '语义网络图.png';
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatus('图片下载成功！', 'success');
        
        // 发送下载通知
        sendNotification('image_download', {
          fileName: '语义网络图.png',
          background: currentBackground
        });
        
      } catch (error) {
        console.error('❌ 图片下载错误:', error);
        showStatus('图片下载失败: ' + error.message, 'error');
      }
    }
    
    // 页面加载完成后初始化
    window.addEventListener('load', function() {
      console.log('🚀 页面加载完成，开始初始化...');
      
      // 初始化图表
      initChart();
      
      // 绑定文件上传事件
      const fileInput = document.getElementById('file');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileUpload);
        console.log('✅ 文件上传事件绑定成功');
      }
      
      // 绑定下载按钮事件
      const downloadBtn = document.getElementById('download');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadImage);
        console.log('✅ 下载按钮事件绑定成功');
      }
      
      console.log('🎉 所有初始化完成！');
    });
    
    // 页面卸载时清理动画
    window.addEventListener('beforeunload', function() {
      if (animationInterval) {
        clearInterval(animationInterval);
      }
    });
    
  </script>
</body>
</html>
