<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­ä¹‰ç½‘ç»œå›¾ç”Ÿæˆå™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
    }
    
    .header {
      flex-shrink: 0;
      margin-bottom: 30px;
    }
    
    .upload-section {
      flex-shrink: 0;
      margin-bottom: 30px;
      padding: 25px;
      border: 2px dashed #007bff;
      border-radius: 8px;
      text-align: center;
      background: #f8f9ff;
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      display: inline-block;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #0056b3, #004085);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #1e7e34, #155724);
    }
    
    .btn-info {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
    }
    
    .btn-info:hover {
      background: linear-gradient(135deg, #138496, #0f6674);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      color: #212529;
    }
    
    .btn-warning:hover {
      background: linear-gradient(135deg, #e0a800, #d39e00);
    }
    
    /* åº•è‰²åˆ‡æ¢æ§åˆ¶åŒºåŸŸ */
    .background-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .background-controls label {
      font-weight: 500;
      color: #495057;
      margin-right: 10px;
    }
    
    .background-selector {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .background-option {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 12px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }
    
    .background-option:hover {
      border-color: #007bff;
      transform: translateY(-1px);
    }
    
    .background-option.active {
      border-color: #007bff;
      background: #e3f2fd;
      box-shadow: 0 2px 4px rgba(0,123,255,0.2);
    }
    
    .background-option input[type="radio"] {
      margin: 0;
    }
    
    .background-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: inline-block;
    }
    
    .bg-gradient1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .bg-gradient2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .bg-gradient3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .bg-gradient4 {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .bg-gradient5 {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .bg-gradient6 {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }
    
    .bg-dark {
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    }
    
    .bg-none {
      background: #ffffff;
    }
    
    #file {
      margin: 10px 0;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    #file:hover {
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0,123,255,0.1);
    }
    
    .chart-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    #main {
      width: 100%;
      height: 500px;
      min-height: 400px;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      overflow: hidden;
    }
    
    #main:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    #main::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, 
        rgba(255,255,255,0.1) 0%, 
        rgba(255,255,255,0.05) 50%, 
        rgba(255,255,255,0.1) 100%);
      pointer-events: none;
    }
    
    /* æ— åº•è‰²æ ·å¼ */
    #main.no-background {
      background: #ffffff;
    }
    
    #main.no-background::before {
      display: none;
    }
    
    #status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-weight: 500;
    }
    
    .status {
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      animation: fadeIn 0.3s ease-in-out;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.05);
        opacity: 0.8;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    @keyframes glow {
      0% {
        box-shadow: 0 0 5px rgba(0,123,255,0.3);
      }
      50% {
        box-shadow: 0 0 20px rgba(0,123,255,0.6);
      }
      100% {
        box-shadow: 0 0 5px rgba(0,123,255,0.3);
      }
    }
    
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
      font-size: 28px;
      animation: slideInDown 0.5s ease-out;
    }
    
    @keyframes slideInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .description {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
      line-height: 1.6;
      animation: fadeIn 0.5s ease-out 0.2s both;
    }
    
    .upload-section {
      animation: fadeIn 0.5s ease-out 0.4s both;
    }
    
    .footer {
      flex-shrink: 0;
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
      color: #999;
      font-size: 14px;
      animation: fadeIn 0.5s ease-out 0.6s both;
    }
    
    .debug-info {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 12px;
      color: #666;
      text-align: left;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
        min-height: calc(100vh - 20px);
      }
      
      h1 {
        font-size: 24px;
      }
      
      .description {
        font-size: 14px;
      }
      
      .button-group {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn {
        width: 100%;
        max-width: 300px;
      }
      
      #main {
        height: 400px;
      }
      
      .background-selector {
        justify-content: center;
      }
      
      .background-controls {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }
      
      h1 {
        font-size: 20px;
      }
      
      #main {
        height: 350px;
      }
    }
    
    /* ç¡®ä¿åœ¨æ‰€æœ‰ç¼©æ”¾çº§åˆ«ä¸‹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º */
    @media (min-width: 1400px) {
      .container {
        max-width: 1400px;
      }
      
      #main {
        height: 600px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸŒ è¯­ä¹‰ç½‘ç»œå›¾ç”Ÿæˆå™¨</h1>
      <p class="description">
        ä¸Šä¼ Excelæ–‡ä»¶ï¼Œè‡ªåŠ¨ç”Ÿæˆç¾è§‚çš„è¯­ä¹‰ç½‘ç»œå›¾ã€‚æ”¯æŒèŠ‚ç‚¹åˆ†ç±»ã€å…³ç³»å±•ç¤ºå’Œå›¾ç‰‡å¯¼å‡ºåŠŸèƒ½ã€‚
      </p>
    </div>
    
    <div class="upload-section">
      <div class="button-group">
        <button class="btn btn-info" onclick="downloadTemplate()">ğŸ“¥ ä¸‹è½½æ•°æ®æ¨¡ç‰ˆ</button>
        <input type="file" id="file" accept=".xlsx,.xls" class="btn">
        <button class="btn btn-success" id="download" style="display:none;">ğŸ–¼ï¸ ä¸‹è½½å›¾ç‰‡</button>
      </div>
      <div id="status"></div>
    </div>
    
    <!-- åº•è‰²åˆ‡æ¢æ§åˆ¶åŒºåŸŸ -->
    <div class="background-controls">
      <label>ğŸ¨ é€‰æ‹©å›¾è¡¨åº•è‰²ï¼š</label>
      <div class="background-selector">
        <div class="background-option active" onclick="changeBackground('gradient1')">
          <input type="radio" name="background" value="gradient1" checked>
          <span class="background-preview bg-gradient1"></span>
          <span>ç´«è“æ¸å˜</span>
        </div>
        <div class="background-option" onclick="changeBackground('gradient2')">
          <input type="radio" name="background" value="gradient2">
          <span class="background-preview bg-gradient2"></span>
          <span>ç²‰çº¢æ¸å˜</span>
        </div>
        <div class="background-option" onclick="changeBackground('gradient3')">
          <input type="radio" name="background" value="gradient3">
          <span class="background-preview bg-gradient3"></span>
          <span>è“é’æ¸å˜</span>
        </div>
        <div class="background-option" onclick="changeBackground('gradient4')">
          <input type="radio" name="background" value="gradient4">
          <span class="background-preview bg-gradient4"></span>
          <span>ç»¿é’æ¸å˜</span>
        </div>
        <div class="background-option" onclick="changeBackground('gradient5')">
          <input type="radio" name="background" value="gradient5">
          <span class="background-preview bg-gradient5"></span>
          <span>ç²‰é»„æ¸å˜</span>
        </div>
        <div class="background-option" onclick="changeBackground('gradient6')">
          <input type="radio" name="background" value="gradient6">
          <span class="background-preview bg-gradient6"></span>
          <span>æ·¡é›…æ¸å˜</span>
        </div>
        <div class="background-option" onclick="changeBackground('dark')">
          <input type="radio" name="background" value="dark">
          <span class="background-preview bg-dark"></span>
          <span>æ·±è‰²ä¸»é¢˜</span>
        </div>
        <div class="background-option" onclick="changeBackground('none')">
          <input type="radio" name="background" value="none">
          <span class="background-preview bg-none"></span>
          <span>æ— åº•è‰²</span>
        </div>
      </div>
    </div>
    
    <div class="chart-container">
      <div id="main"></div>
    </div>
    
    <div class="footer">
      <p>æ”¯æŒçš„æ ¼å¼ï¼šExcel (.xlsx, .xls) | ç”Ÿæˆé«˜è´¨é‡PNGå›¾ç‰‡ | ğŸ†• æ”¯æŒå¤šç§åº•è‰²ä¸»é¢˜</p>
      <p>Â© 2025 è¯­ä¹‰ç½‘ç»œå›¾ç”Ÿæˆå™¨ - è®©æ•°æ®å¯è§†åŒ–æ›´ç®€å•</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <script>
    // å…¨å±€å˜é‡
    let chart;
    let currentGraphData = null;
    let animationInterval;
    let currentBackground = 'gradient1';
    
    // åº•è‰²é…ç½®
    const backgroundStyles = {
      'gradient1': {
        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        showOverlay: true
      },
      'gradient2': {
        background: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        showOverlay: true
      },
      'gradient3': {
        background: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        showOverlay: true
      },
      'gradient4': {
        background: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        showOverlay: true
      },
      'gradient5': {
        background: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        showOverlay: true
      },
      'gradient6': {
        background: 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
        showOverlay: true
      },
      'dark': {
        background: 'linear-gradient(135deg, #2c3e50 0%, #34495e 100%)',
        showOverlay: true
      },
      'none': {
        background: '#ffffff',
        showOverlay: false
      }
    };
    
    // æ¨¡ç‰ˆæ•°æ®
    const templateData = [
      ['èŠ‚ç‚¹A', 'èŠ‚ç‚¹B', 'å…³ç³»ç±»å‹', 'èŠ‚ç‚¹Aç±»å‹', 'èŠ‚ç‚¹Bç±»å‹'],
      ['è¥¿æ¹–', 'ç¾ä¸½', 'æ­£é¢è¯„ä»·', 'æ—…æ¸¸åœ°', 'æ­£é¢è¯„è®ºè¯'],
      ['è¥¿æ¹–', 'è´µ', 'è´Ÿé¢è¯„ä»·', 'æ—…æ¸¸åœ°', 'è´Ÿé¢è¯„è®ºè¯'],
      ['è¥¿æ¹–', 'è‡ªç„¶æ™¯è§‚', 'åŒ…å«è¦ç´ ', 'æ—…æ¸¸åœ°', 'æ—…æ¸¸è¦ç´ '],
      ['è‡ªç„¶æ™¯è§‚', 'å£®è§‚', 'æ­£é¢å…³è”', 'æ—…æ¸¸è¦ç´ ', 'æ­£é¢è¯„è®ºè¯'],
      ['ç¾ä¸½', 'å£®è§‚', 'æƒ…æ„Ÿå…³è”', 'æ­£é¢è¯„è®ºè¯', 'æ­£é¢è¯„è®ºè¯'],
      ['æ–­æ¡¥', 'æµªæ¼«', 'æ­£é¢è¯„ä»·', 'æ™¯ç‚¹', 'æ­£é¢è¯„è®ºè¯'],
      ['é›·å³°å¡”', 'å†å²', 'æ–‡åŒ–å…³è”', 'æ™¯ç‚¹', 'æ—…æ¸¸è¦ç´ '],
      ['ä¸‰æ½­å°æœˆ', 'å®é™', 'æ­£é¢è¯„ä»·', 'æ™¯ç‚¹', 'æ­£é¢è¯„è®ºè¯'],
      ['æ¸¸èˆ¹', 'ä½“éªŒ', 'æ´»åŠ¨å…³è”', 'æ—…æ¸¸è¦ç´ ', 'æ—…æ¸¸è¦ç´ '],
      ['é—¨ç¥¨', 'æ˜‚è´µ', 'è´Ÿé¢è¯„ä»·', 'æ—…æ¸¸è¦ç´ ', 'è´Ÿé¢è¯„è®ºè¯']
    ];
    
    // åº•è‰²åˆ‡æ¢å‡½æ•°
    function changeBackground(backgroundType) {
      currentBackground = backgroundType;
      const mainElement = document.getElementById('main');
      const style = backgroundStyles[backgroundType];
      
      // æ›´æ–°æ ·å¼
      mainElement.style.background = style.background;
      
      // æ§åˆ¶overlayæ˜¾ç¤º
      if (style.showOverlay) {
        mainElement.classList.remove('no-background');
      } else {
        mainElement.classList.add('no-background');
      }
      
      // æ›´æ–°é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.background-option').forEach(option => {
        option.classList.remove('active');
      });
      
      const selectedOption = document.querySelector(`[onclick="changeBackground('${backgroundType}')"]`);
      if (selectedOption) {
        selectedOption.classList.add('active');
        const radio = selectedOption.querySelector('input[type="radio"]');
        if (radio) radio.checked = true;
      }
      
      // å¦‚æœå·²æœ‰å›¾è¡¨ï¼Œé‡æ–°æ¸²æŸ“ä»¥é€‚åº”æ–°èƒŒæ™¯
      if (chart && currentGraphData) {
        updateChartBackground();
      }
      
      console.log('ğŸ¨ åº•è‰²å·²åˆ‡æ¢ä¸º:', backgroundType);
    }
    
    // æ›´æ–°å›¾è¡¨èƒŒæ™¯é€‚é…
    function updateChartBackground() {
      if (!chart || !currentGraphData) return;
      
      const option = chart.getOption();
      
      // æ ¹æ®èƒŒæ™¯è°ƒæ•´æ–‡å­—é¢œè‰²
      const textColor = currentBackground === 'dark' ? '#ffffff' : 
                       currentBackground === 'none' ? '#333333' : '#ffffff';
      
      // æ›´æ–°å›¾è¡¨é…ç½®
      const updatedOption = {
        ...option,
        backgroundColor: 'transparent',
        textStyle: {
          color: textColor
        },
        legend: {
          ...option.legend[0],
          textStyle: {
            color: textColor,
            fontSize: 14
          }
        }
      };
      
      chart.setOption(updatedOption, true);
    }
    
    // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      if (statusDiv) {
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        if (type === 'error') {
          console.error(message);
        }
      }
    }
    
    // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
    function showDebugInfo(data) {
      const statusDiv = document.getElementById('status');
      if (statusDiv) {
        const debugHtml = `
          <div class="debug-info">
            <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
            æ–‡ä»¶å: ${data.fileName || 'N/A'}<br>
            åŸå§‹æ•°æ®è¡Œæ•°: ${data.totalRows || 0}<br>
            æœ‰æ•ˆæ•°æ®è¡Œæ•°: ${data.validRows || 0}<br>
            èŠ‚ç‚¹æ•°: ${data.nodeCount || 0}<br>
            è¿æ¥æ•°: ${data.linkCount || 0}<br>
            èŠ‚ç‚¹ç±»å‹: ${data.categories ? data.categories.join(', ') : 'N/A'}
          </div>
        `;
        statusDiv.innerHTML += debugHtml;
      }
    }
    
    // é€šçŸ¥å‘é€å‡½æ•°
    async function sendNotification(action, fileInfo = {}) {
      try {
        console.log('ğŸ”” å‘é€é€šçŸ¥:', action, fileInfo);
        
        const response = await fetch('/api/notify', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action: action,
            fileInfo: fileInfo
          })
        });

        console.log('ğŸ“¡ APIå“åº”çŠ¶æ€:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('ğŸ“‹ APIå“åº”å†…å®¹:', result);
        
        if (result.success) {
          console.log('âœ… é€šçŸ¥å‘é€æˆåŠŸ');
        } else {
          console.error('âŒ é€šçŸ¥å‘é€å¤±è´¥:', result);
        }
      } catch (error) {
        console.error('ğŸš¨ é€šçŸ¥å‘é€å¼‚å¸¸:', error);
        // é™é»˜å¤„ç†é€šçŸ¥é”™è¯¯ï¼Œä¸æ˜¾ç¤ºç»™ç”¨æˆ·
      }
    }
    
    // ä¸‹è½½æ•°æ®æ¨¡ç‰ˆ
    function downloadTemplate() {
      console.log('ğŸ“¥ ä¸‹è½½æ¨¡ç‰ˆå‡½æ•°è¢«è°ƒç”¨');
      try {
        const ws = XLSX.utils.aoa_to_sheet(templateData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'æ•°æ®æ¨¡ç‰ˆ');
        
        const colWidths = [
          { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 }, { wch: 15 }
        ];
        ws['!cols'] = colWidths;
        
        XLSX.writeFile(wb, 'è¯­ä¹‰ç½‘ç»œå›¾æ•°æ®æ¨¡ç‰ˆ.xlsx');
        showStatus('æ•°æ®æ¨¡ç‰ˆä¸‹è½½æˆåŠŸï¼è¯·æŒ‰ç…§æ¨¡ç‰ˆæ ¼å¼å¡«å†™æ•°æ®', 'success');
        sendNotification('template_download');
      } catch (error) {
        showStatus('æ¨¡ç‰ˆä¸‹è½½å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // è·å–èŠ‚ç‚¹é¢œè‰²
    function getNodeColor(nodeType) {
      const colorMap = {
        'æ—…æ¸¸åœ°': '#FF6B6B',
        'æ­£é¢è¯„è®ºè¯': '#4ECDC4',
        'è´Ÿé¢è¯„è®ºè¯': '#FFE66D', 
        'æ—…æ¸¸è¦ç´ ': '#95E1D3',
        'æ‹“å±•è¦ç´ ': '#A8E6CF',
        'æ™¯ç‚¹': '#FF8B94',
        'æ´»åŠ¨': '#FFD93D',
        'ä½“éªŒ': '#6BCF7F',
        'è®¾æ–½': '#4D96FF',
        'æœåŠ¡': '#9B59B6'
      };
      return colorMap[nodeType] || '#95A5A6';
    }
    
    // åˆ›å»ºç‚«é…·çš„ç¤ºä¾‹æ•°æ®
    function createDemoData() {
      const nodes = [
        // æ—…æ¸¸åœ°
        {id: 'è¥¿æ¹–', name: 'è¥¿æ¹–', category: 0, nodeType: 'æ—…æ¸¸åœ°', value: 100, itemStyle: {color: '#FF6B6B'}},
        {id: 'æ–­æ¡¥', name: 'æ–­æ¡¥', category: 0, nodeType: 'æ™¯ç‚¹', value: 80, itemStyle: {color: '#FF8B94'}},
        {id: 'é›·å³°å¡”', name: 'é›·å³°å¡”', category: 0, nodeType: 'æ™¯ç‚¹', value: 85, itemStyle: {color: '#FF8B94'}},
        {id: 'ä¸‰æ½­å°æœˆ', name: 'ä¸‰æ½­å°æœˆ', category: 0, nodeType: 'æ™¯ç‚¹', value: 75, itemStyle: {color: '#FF8B94'}},
        
        // æ­£é¢è¯„è®ºè¯
        {id: 'ç¾ä¸½', name: 'ç¾ä¸½', category: 1, nodeType: 'æ­£é¢è¯„è®ºè¯', value: 90, itemStyle: {color: '#4ECDC4'}},
        {id: 'å£®è§‚', name: 'å£®è§‚', category: 1, nodeType: 'æ­£é¢è¯„è®ºè¯', value: 85, itemStyle: {color: '#4ECDC4'}},
        {id: 'æµªæ¼«', name: 'æµªæ¼«', category: 1, nodeType: 'æ­£é¢è¯„è®ºè¯', value: 80, itemStyle: {color: '#4ECDC4'}},
        {id: 'å®é™', name: 'å®é™', category: 1, nodeType: 'æ­£é¢è¯„è®ºè¯', value: 75, itemStyle: {color: '#4ECDC4'}},
        {id: 'èˆ’é€‚', name: 'èˆ’é€‚', category: 1, nodeType: 'æ­£é¢è¯„è®ºè¯', value: 70, itemStyle: {color: '#4ECDC4'}},
        
        // è´Ÿé¢è¯„è®ºè¯
        {id: 'è´µ', name: 'è´µ', category: 2, nodeType: 'è´Ÿé¢è¯„è®ºè¯', value: 60, itemStyle: {color: '#FFE66D'}},
        {id: 'æ‹¥æŒ¤', name: 'æ‹¥æŒ¤', category: 2, nodeType: 'è´Ÿé¢è¯„è®ºè¯', value: 65, itemStyle: {color: '#FFE66D'}},
        {id: 'æ˜‚è´µ', name: 'æ˜‚è´µ', category: 2, nodeType: 'è´Ÿé¢è¯„è®ºè¯', value: 55, itemStyle: {color: '#FFE66D'}},
        
        // æ—…æ¸¸è¦ç´ 
        {id: 'è‡ªç„¶æ™¯è§‚', name: 'è‡ªç„¶æ™¯è§‚', category: 3, nodeType: 'æ—…æ¸¸è¦ç´ ', value: 95, itemStyle: {color: '#95E1D3'}},
        {id: 'å†å²', name: 'å†å²', category: 3, nodeType: 'æ—…æ¸¸è¦ç´ ', value: 85, itemStyle: {color: '#95E1D3'}},
        {id: 'æ–‡åŒ–', name: 'æ–‡åŒ–', category: 3, nodeType: 'æ—…æ¸¸è¦ç´ ', value: 80, itemStyle: {color: '#95E1D3'}},
        {id: 'ä½“éªŒ', name: 'ä½“éªŒ', category: 3, nodeType: 'æ—…æ¸¸è¦ç´ ', value: 75, itemStyle: {color: '#95E1D3'}},
        {id: 'æ¸¸èˆ¹', name: 'æ¸¸èˆ¹', category: 3, nodeType: 'æ—…æ¸¸è¦ç´ ', value: 70, itemStyle: {color: '#95E1D3'}},
        {id: 'é—¨ç¥¨', name: 'é—¨ç¥¨', category: 3, nodeType: 'æ—…æ¸¸è¦ç´ ', value: 65, itemStyle: {color: '#95E1D3'}},
        
        // æ‹“å±•è¦ç´ 
        {id: 'æ‘„å½±', name: 'æ‘„å½±', category: 4, nodeType: 'æ‹“å±•è¦ç´ ', value: 60, itemStyle: {color: '#A8E6CF'}},
        {id: 'æ•£æ­¥', name: 'æ•£æ­¥', category: 4, nodeType: 'æ‹“å±•è¦ç´ ', value: 55, itemStyle: {color: '#A8E6CF'}},
        {id: 'è§‚å…‰', name: 'è§‚å…‰', category: 4, nodeType: 'æ‹“å±•è¦ç´ ', value: 65, itemStyle: {color: '#A8E6CF'}},
      ];
      
      const links = [
        // æ ¸å¿ƒå…³ç³»
        {source: 'è¥¿æ¹–', target: 'ç¾ä¸½', value: 10, lineStyle: {color: '#4ECDC4', width: 4}},
        {source: 'è¥¿æ¹–', target: 'è‡ªç„¶æ™¯è§‚', value: 9, lineStyle: {color: '#95E1D3', width: 4}},
        {source: 'è¥¿æ¹–', target: 'è´µ', value: 6, lineStyle: {color: '#FFE66D', width: 3}},
        {source: 'è¥¿æ¹–', target: 'æ–­æ¡¥', value: 8, lineStyle: {color: '#FF8B94', width: 3}},
        {source: 'è¥¿æ¹–', target: 'é›·å³°å¡”', value: 8, lineStyle: {color: '#FF8B94', width: 3}},
        {source: 'è¥¿æ¹–', target: 'ä¸‰æ½­å°æœˆ', value: 7, lineStyle: {color: '#FF8B94', width: 3}},
        
        // æ™¯ç‚¹å…³ç³»
        {source: 'æ–­æ¡¥', target: 'æµªæ¼«', value: 8, lineStyle: {color: '#4ECDC4', width: 3}},
        {source: 'é›·å³°å¡”', target: 'å†å²', value: 9, lineStyle: {color: '#95E1D3', width: 3}},
        {source: 'ä¸‰æ½­å°æœˆ', target: 'å®é™', value: 7, lineStyle: {color: '#4ECDC4', width: 3}},
        
        // è¦ç´ å…³ç³»
        {source: 'è‡ªç„¶æ™¯è§‚', target: 'å£®è§‚', value: 8, lineStyle: {color: '#4ECDC4', width: 3}},
        {source: 'å†å²', target: 'æ–‡åŒ–', value: 9, lineStyle: {color: '#95E1D3', width: 3}},
        {source: 'ä½“éªŒ', target: 'èˆ’é€‚', value: 6, lineStyle: {color: '#4ECDC4', width: 2}},
        {source: 'æ¸¸èˆ¹', target: 'ä½“éªŒ', value: 7, lineStyle: {color: '#95E1D3', width: 2}},
        {source: 'é—¨ç¥¨', target: 'æ˜‚è´µ', value: 7, lineStyle: {color: '#FFE66D', width: 3}},
        
        // æƒ…æ„Ÿå…³è”
        {source: 'ç¾ä¸½', target: 'å£®è§‚', value: 6, lineStyle: {color: '#4ECDC4', width: 2}},
        {source: 'æµªæ¼«', target: 'ç¾ä¸½', value: 5, lineStyle: {color: '#4ECDC4', width: 2}},
        {source: 'è´µ', target: 'æ‹¥æŒ¤', value: 5, lineStyle: {color: '#FFE66D', width: 2}},
        
        // æ‹“å±•å…³ç³»
        {source: 'è‡ªç„¶æ™¯è§‚', target: 'æ‘„å½±', value: 6, lineStyle: {color: '#A8E6CF', width: 2}},
        {source: 'å®é™', target: 'æ•£æ­¥', value: 5, lineStyle: {color: '#A8E6CF', width: 2}},
        {source: 'ç¾ä¸½', target: 'è§‚å…‰', value: 7, lineStyle: {color: '#A8E6CF', width: 2}},
        {source: 'å†å²', target: 'è§‚å…‰', value: 6, lineStyle: {color: '#A8E6CF', width: 2}},
        
        // äº¤å‰å…³ç³»
        {source: 'æ–­æ¡¥', target: 'æ‘„å½±', value: 5, lineStyle: {color: '#A8E6CF', width: 2}},
        {source: 'é›·å³°å¡”', target: 'è§‚å…‰', value: 6, lineStyle: {color: '#A8E6CF', width: 2}},
        {source: 'æ‹¥æŒ¤', target: 'ä½“éªŒ', value: 4, lineStyle: {color: '#FFE66D', width: 2}},
      ];
      
      const categories = [
        {name: 'æ—…æ¸¸åœ°', itemStyle: {color: '#FF6B6B'}},
        {name: 'æ­£é¢è¯„è®ºè¯', itemStyle: {color: '#4ECDC4'}},
        {name: 'è´Ÿé¢è¯„è®ºè¯', itemStyle: {color: '#FFE66D'}},
        {name: 'æ—…æ¸¸è¦ç´ ', itemStyle: {color: '#95E1D3'}},
        {name: 'æ‹“å±•è¦ç´ ', itemStyle: {color: '#A8E6CF'}}
      ];
      
      return { nodes, links, categories };
    }
    
    // åˆå§‹åŒ–å›¾è¡¨
    function initChart() {
      const mainElement = document.getElementById('main');
      if (!mainElement) {
        console.error('æ‰¾ä¸åˆ°å›¾è¡¨å®¹å™¨');
        return;
      }
      
      chart = echarts.init(mainElement);
      
      // åˆ›å»ºç¤ºä¾‹æ•°æ®
      const demoData = createDemoData();
      currentGraphData = demoData;
      
      // é…ç½®é€‰é¡¹
      const option = {
        backgroundColor: 'transparent',
        animationDurationUpdate: 1500,
        animationEasingUpdate: 'quinticInOut',
        title: {
          text: 'è¯­ä¹‰ç½‘ç»œå›¾',
          left: 'center',
          top: 20,
          textStyle: {
            color: '#ffffff',
            fontSize: 24,
            fontWeight: 'bold'
          }
        },
        tooltip: {
          trigger: 'item',
          formatter: function(params) {
            if (params.dataType === 'node') {
              return `<div style="padding: 10px;">
                <strong>${params.data.name}</strong><br/>
                ç±»å‹: ${params.data.nodeType}<br/>
                æƒé‡: ${params.data.value}
              </div>`;
            } else if (params.dataType === 'edge') {
              return `<div style="padding: 10px;">
                <strong>${params.data.source} â†’ ${params.data.target}</strong><br/>
                å…³ç³»å¼ºåº¦: ${params.data.value}
              </div>`;
            }
          },
          backgroundColor: 'rgba(0,0,0,0.8)',
          borderColor: '#777',
          textStyle: {
            color: '#fff'
          }
        },
        legend: {
          orient: 'horizontal',
          bottom: 20,
          data: demoData.categories.map(cat => cat.name),
          textStyle: {
            color: '#ffffff',
            fontSize: 14
          },
          itemGap: 20
        },
        series: [{
          name: 'è¯­ä¹‰ç½‘ç»œ',
          type: 'graph',
          layout: 'force',
          data: demoData.nodes,
          links: demoData.links,
          categories: demoData.categories,
          roam: true,
          focusNodeAdjacency: true,
          itemStyle: {
            borderColor: '#fff',
            borderWidth: 2,
            shadowBlur: 10,
            shadowColor: 'rgba(0, 0, 0, 0.3)'
          },
          label: {
            show: true,
            position: 'inside',
            formatter: '{b}',
            fontSize: 12,
            fontWeight: 'bold',
            color: '#fff',
            textShadowColor: 'rgba(0, 0, 0, 0.8)',
            textShadowBlur: 2
          },
          lineStyle: {
            opacity: 0.8,
            width: 2,
            curveness: 0.3
          },
          emphasis: {
            focus: 'adjacency',
            lineStyle: {
              width: 6
            },
            itemStyle: {
              shadowBlur: 20,
              shadowColor: 'rgba(0, 0, 0, 0.5)'
            }
          },
          force: {
            repulsion: 2000,
            gravity: 0.1,
            edgeLength: [100, 200],
            layoutAnimation: true
          }
        }]
      };
      
      chart.setOption(option);
      
      // å¯åŠ¨åŠ¨ç”»æ•ˆæœ
      startAnimation();
      
      // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°è°ƒæ•´å›¾è¡¨
      window.addEventListener('resize', () => {
        if (chart) {
          chart.resize();
        }
      });
      
      console.log('âœ… å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
    }
    
    // å¯åŠ¨åŠ¨ç”»æ•ˆæœ
    function startAnimation() {
      if (animationInterval) {
        clearInterval(animationInterval);
      }
      
      let animationStep = 0;
      animationInterval = setInterval(() => {
        if (chart && currentGraphData) {
          const option = chart.getOption();
          const series = option.series[0];
          
          // åˆ›å»ºæ³¢åŠ¨æ•ˆæœ
          const animatedNodes = series.data.map(node => ({
            ...node,
            symbolSize: node.value * 0.8 + Math.sin(animationStep * 0.1 + node.value * 0.1) * 5
          }));
          
          chart.setOption({
            series: [{
              ...series,
              data: animatedNodes
            }]
          }, false);
          
          animationStep++;
        }
      }, 100);
    }
    
    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      console.log('ğŸ“ å¼€å§‹å¤„ç†æ–‡ä»¶:', file.name);
      showStatus('æ­£åœ¨å¤„ç†æ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
          
          console.log('ğŸ“Š è§£æçš„æ•°æ®:', jsonData);
          
          if (jsonData.length < 2) {
            throw new Error('æ–‡ä»¶æ•°æ®ä¸è¶³ï¼Œè¯·ç¡®ä¿è‡³å°‘æœ‰æ ‡é¢˜è¡Œå’Œä¸€è¡Œæ•°æ®');
          }
          
          // å¤„ç†æ•°æ®
          const graphData = processExcelData(jsonData);
          
          if (graphData.nodes.length === 0) {
            throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„èŠ‚ç‚¹æ•°æ®');
          }
          
          // æ›´æ–°å›¾è¡¨
          updateChart(graphData);
          
          // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
          const downloadBtn = document.getElementById('download');
          if (downloadBtn) {
            downloadBtn.style.display = 'inline-block';
          }
          
          showStatus(`æ–‡ä»¶å¤„ç†æˆåŠŸï¼ç”Ÿæˆäº† ${graphData.nodes.length} ä¸ªèŠ‚ç‚¹å’Œ ${graphData.links.length} ä¸ªè¿æ¥`, 'success');
          
          // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
          showDebugInfo({
            fileName: file.name,
            totalRows: jsonData.length,
            validRows: jsonData.length - 1,
            nodeCount: graphData.nodes.length,
            linkCount: graphData.links.length,
            categories: graphData.categories.map(cat => cat.name)
          });
          
          // å‘é€ä¸Šä¼ é€šçŸ¥
          sendNotification('file_upload', {
            fileName: file.name,
            fileSize: file.size,
            nodeCount: graphData.nodes.length,
            linkCount: graphData.links.length
          });
          
        } catch (error) {
          console.error('âŒ æ–‡ä»¶å¤„ç†é”™è¯¯:', error);
          showStatus('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message, 'error');
        }
      };
      
      reader.readAsArrayBuffer(file);
    }
    
    // å¤„ç†Excelæ•°æ®
    function processExcelData(jsonData) {
      const headers = jsonData[0];
      const dataRows = jsonData.slice(1);
      
      console.log('ğŸ“‹ è¡¨å¤´:', headers);
      console.log('ğŸ“‹ æ•°æ®è¡Œæ•°:', dataRows.length);
      
      const nodes = new Map();
      const links = [];
      const categorySet = new Set();
      
      dataRows.forEach((row, index) => {
        if (row.length < 2) return;
        
        const nodeA = row[0];
        const nodeB = row[1];
        const relation = row[2] || 'å…³è”';
        const typeA = row[3] || 'é»˜è®¤ç±»å‹';
        const typeB = row[4] || 'é»˜è®¤ç±»å‹';
        
        if (!nodeA || !nodeB) return;
        
        // æ·»åŠ èŠ‚ç‚¹
        if (!nodes.has(nodeA)) {
          nodes.set(nodeA, {
            id: nodeA,
            name: nodeA,
            nodeType: typeA,
            value: 50,
            itemStyle: { color: getNodeColor(typeA) }
          });
          categorySet.add(typeA);
        }
        
        if (!nodes.has(nodeB)) {
          nodes.set(nodeB, {
            id: nodeB,
            name: nodeB,
            nodeType: typeB,
            value: 50,
            itemStyle: { color: getNodeColor(typeB) }
          });
          categorySet.add(typeB);
        }
        
        // æ·»åŠ è¿æ¥
        links.push({
          source: nodeA,
          target: nodeB,
          value: 5,
          relation: relation,
          lineStyle: {
            color: getNodeColor(typeA),
            width: 2
          }
        });
      });
      
      // è®¾ç½®åˆ†ç±»
      const categories = Array.from(categorySet).map((type, index) => ({
        name: type,
        itemStyle: { color: getNodeColor(type) }
      }));
      
      // ä¸ºèŠ‚ç‚¹è®¾ç½®åˆ†ç±»ç´¢å¼•
      const nodeArray = Array.from(nodes.values()).map(node => {
        const categoryIndex = categories.findIndex(cat => cat.name === node.nodeType);
        return {
          ...node,
          category: categoryIndex >= 0 ? categoryIndex : 0
        };
      });
      
      return {
        nodes: nodeArray,
        links: links,
        categories: categories
      };
    }
    
    // ä¸‹è½½å›¾ç‰‡
    function downloadImage() {
      if (!chart) {
        showStatus('è¯·å…ˆä¸Šä¼ æ–‡ä»¶ç”Ÿæˆå›¾è¡¨', 'error');
        return;
      }
      
      try {
        const url = chart.getDataURL({
          pixelRatio: 2,
          backgroundColor: '#fff'
        });
        
        const link = document.createElement('a');
        link.download = 'è¯­ä¹‰ç½‘ç»œå›¾.png';
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showStatus('å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼', 'success');
        
        // å‘é€ä¸‹è½½é€šçŸ¥
        sendNotification('image_download', {
          fileName: 'è¯­ä¹‰ç½‘ç»œå›¾.png',
          background: currentBackground
        });
        
      } catch (error) {
        console.error('âŒ å›¾ç‰‡ä¸‹è½½é”™è¯¯:', error);
        showStatus('å›¾ç‰‡ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', function() {
      console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
      
      // åˆå§‹åŒ–å›¾è¡¨
      initChart();
      
      // ç»‘å®šæ–‡ä»¶ä¸Šä¼ äº‹ä»¶
      const fileInput = document.getElementById('file');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileUpload);
        console.log('âœ… æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç»‘å®šæˆåŠŸ');
      }
      
      // ç»‘å®šä¸‹è½½æŒ‰é’®äº‹ä»¶
      const downloadBtn = document.getElementById('download');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadImage);
        console.log('âœ… ä¸‹è½½æŒ‰é’®äº‹ä»¶ç»‘å®šæˆåŠŸ');
      }
      
      console.log('ğŸ‰ æ‰€æœ‰åˆå§‹åŒ–å®Œæˆï¼');
    });
    
    // é¡µé¢å¸è½½æ—¶æ¸…ç†åŠ¨ç”»
    window.addEventListener('beforeunload', function() {
      if (animationInterval) {
        clearInterval(animationInterval);
      }
    });
    
  </script>
</body>
</html>
